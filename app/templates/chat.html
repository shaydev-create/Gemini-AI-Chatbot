<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-buster" content="v1.0.1-20250112-fix">
    <meta name="description" content="Chat con Gemini AI - Experimenta conversaciones inteligentes con la IA m√°s avanzada. Interfaz moderna y respuestas instant√°neas.">
    <meta name="keywords" content="chat AI, Gemini, conversaci√≥n inteligente, chatbot, asistente virtual">
    <meta name="author" content="Gemini AI Team">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://gemini-ai.com/chat">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Chat - Gemini AI">
    <meta property="og:description" content="Experimenta conversaciones inteligentes con la IA m√°s avanzada">
    <meta property="og:image" content="{{ url_for('static', filename='images/icon.png') }}">
    <meta property="og:url" content="https://gemini-ai.com/chat">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Chat - Gemini AI">
    <meta name="twitter:description" content="Experimenta conversaciones inteligentes con la IA m√°s avanzada">
    <meta name="twitter:image" content="{{ url_for('static', filename='images/icon.png') }}">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#00f5ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/static/manifest.json">
    
    
    <title>{{ translate('title') }}</title>
    <!-- jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Gemini AI Chat",
      "description": "Chat con Gemini AI - Experimenta conversaciones inteligentes con la IA m√°s avanzada",
      "url": "https://gemini-ai.com/chat",
      "applicationCategory": "ChatApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Gemini AI Team"
      }
    }
    </script>
    <style>
        :root {
            --primary: #00f5ff;
            --secondary: #1e3a8a;
            --accent: #3b82f6;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff0066;
            --bot-color: var(--primary);
            --user-color: var(--secondary);

            --bg-card: rgba(255, 255, 255, 0.02);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --glass-bg: rgba(0, 245, 255, 0.008); /* ULTRA TRANSPARENTE */
            --glass-border: rgba(0, 245, 255, 0.03); /* ULTRA TRANSPARENTE */       
            --glow: 0 0 20px var(--primary);
            --neural-grid: linear-gradient(90deg, transparent 98%, rgba(0, 245, 255, 0.1) 100%);
            
            /* Variables de personalizaci√≥n */
            --base-font-size: 1rem;
            --current-bot-avatar: 'ü§ñ';
            
            /* Variables para temas (valores por defecto) */
            --bg-color: #1a1a2e;
            --text-color: #ffffff;
            --accent-color: #667eea;
            --border-color: #333366;
            --hover-bg: #2a2a3e;
            --accent-color-rgb: 102, 126, 234;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        /* Accessibility Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary);
            color: #0a0a0f;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 9999;
            font-weight: bold;
            transition: top 0.3s ease;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Keyboard navigation improvements */
        .send-button:focus,
        .action-btn:focus,
        .back-btn:focus,
        input:focus,
        button:focus {
            outline: 3px solid #00d4ff;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.3);
        }
        
        .send-button:focus,
        .action-btn:focus {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* Ensure all interactive elements are keyboard accessible */
        .send-button,
        .action-btn,
        .back-btn {
            cursor: pointer;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: var(--base-font-size);
        }
        
        #neural-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        

        

        
        .chat-container {
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            background: rgba(5, 10, 20, 0.25); /* Mucho m√°s transparente para resaltar el fondo */
            border-radius: 24px;
            backdrop-filter: blur(2px); /* Blur m√≠nimo para ver el fondo */
            border: 1px solid rgba(100, 150, 255, 0.15);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.2), 
                0 0 0 1px rgba(255, 255, 255, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .chat-header {
            background: var(--glass-bg);
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header-content {
            flex: 1;
            text-align: center;
        }
        
        .chat-header h1 {
            margin-bottom: 5px;
            font-size: 1.8rem;
            font-weight: 700;
            animation: title-glow 2s ease-in-out infinite alternate;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .title-emoji {
            font-size: 1.8rem;
            /* El emoji mantiene sus colores naturales */
        }
        
        .title-text {
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes title-glow {
            0% { filter: drop-shadow(0 0 10px var(--primary)); }
            100% { filter: drop-shadow(0 0 20px var(--secondary)); }
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        

        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            max-width: 80%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message.bot {
            align-self: flex-start;
        }
        
        .message-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: 2px solid rgba(0, 245, 255, 0.5);
            box-shadow: var(--glow);
        }
        
        .message.bot .message-avatar::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: var(--success-color);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            border: 2px solid rgba(30, 58, 138, 0.5);
            box-shadow: 0 0 20px var(--secondary);
        }
        
        .message-content {
            background: rgba(5, 10, 20, 0.15); /* Mucho m√°s transparente */
            padding: 14px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            border: 1px solid rgba(100, 150, 255, 0.1);
            position: relative;
            backdrop-filter: blur(3px); /* Blur m√≠nimo */
            line-height: 1.5;
            font-size: var(--base-font-size);
        }
        
        /* Estilos para contenido formateado del bot */
        .message-content h1, .message-content h2, .message-content h3 {
            color: var(--primary);
            margin: 10px 0 8px 0;
            font-weight: 600;
        }
        
        .message-content h1 { font-size: 1.4rem; }
        .message-content h2 { font-size: 1.2rem; }
        .message-content h3 { font-size: 1.1rem; }
        
        .message-content strong {
            color: var(--text-primary);
            font-weight: 700;
        }
        
        .message-content em {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .message-content code {
            background: rgba(0, 245, 255, 0.1);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .message-content ul {
            margin: 10px 0;
            padding-left: 0;
            list-style: none;
        }
        
        .message-content li {
            margin: 6px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .message-content li::before {
            content: "‚Ä¢";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        .message.bot .message-content {
            background: rgba(0, 245, 255, 0.05); /* Muy transparente */
            border-color: rgba(0, 245, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 245, 255, 0.1);
        }
        
        .message.user .message-content {
            background: rgba(30, 58, 138, 0.05); /* Muy transparente */
            border-color: rgba(30, 58, 138, 0.15);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            opacity: 0.7;
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid rgba(100, 150, 255, 0.1);
            background: rgba(5, 10, 20, 0.1); /* Muy transparente */
        }
        
        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .chat-input input,
        .chat-input textarea {
            width: 100%;
            padding: 16px 24px;
            padding-right: 70px;
            border: 2px solid rgba(100, 150, 255, 0.15);
            border-radius: 25px;
            background: rgba(5, 10, 20, 0.2); /* M√°s transparente */
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            outline: none;
            backdrop-filter: blur(3px); /* Blur m√≠nimo */
            transition: all 0.3s ease;
            resize: none !important; /* Forzar sin resize */
            min-height: 54px;
            max-height: 120px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        /* Asegurar que no haya handle de resize */
        .chat-input textarea {
            resize: none !important;
            overflow: hidden;
        }
        
        .chat-input textarea::-webkit-resizer {
            display: none !important;
        }
        
        .chat-input input::placeholder,
        .chat-input textarea::placeholder {
            color: var(--text-secondary);
        }
        
        .chat-input input:focus,
        .chat-input textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }
        
        .char-counter {
            position: absolute;
            bottom: 8px;
            right: 15px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            pointer-events: none;
        }
        
        .send-button {
            padding: 16px 28px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--glow);
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 54px;
        }
        
        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 245, 255, 0.4);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
        }

        /* Estilos espec√≠ficos para estados de voz */
        .action-btn.playing {
            animation: pulse-voice 2s infinite;
        }

        .action-btn.paused {
            animation: blink-voice 1s infinite;
        }

        @keyframes pulse-voice {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(255, 193, 7, 0.3); 
            }
            50% { 
                box-shadow: 0 0 16px rgba(255, 193, 7, 0.6); 
            }
        }

        @keyframes blink-voice {
            0%, 50% { 
                opacity: 1; 
            }
            51%, 100% { 
                opacity: 0.7; 
            }
        }
        
        /* Estilos para los botones de idioma */
        .lang-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-width: 90px;
        }
        
        .lang-btn[data-lang="es"] {
            order: 4; /* Ordenar despu√©s de los otros botones */
        }
        
        .lang-btn[data-lang="en"] {
            order: 5; /* Ordenar despu√©s del bot√≥n espa√±ol */
        }
        
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            margin-left: 50px;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #4ecdc4;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 20px;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 25px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .back-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.4);
        }
        
        /* Scrollbar personalizada */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Responsive Design Mejorado */
        /* === RESPONSIVE CHAT OPTIMIZADO === */
        
        /* Pantallas Ultra-Wide - Chat optimizado */
        @media (min-width: 1441px) {
            .chat-container {
                max-width: 1200px;
                height: 85vh;
                margin: 0 auto;
            }
            
            .chat-messages {
                padding: 25px 30px;
            }
            
            .message {
                max-width: 70%;
            }
            
            .chat-header {
                padding: 20px 30px;
            }
            
            .chat-input {
                padding: 20px 30px;
            }
        }
        
        /* Tablets Landscape - Chat h√≠brido */
        @media (min-width: 768px) and (max-width: 1440px) {
            .chat-container {
                width: 90%;
                max-width: 900px;
                height: 88vh;
                border-radius: 20px;
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .message {
                max-width: 75%;
            }
            
            .message-avatar {
                width: 42px;
                height: 42px;
                font-size: 20px;
            }
            
            .input-container {
                display: flex;
                flex-direction: row;
                align-items: flex-end;
                gap: 15px;
            }
            
            .message-input {
                flex: 1;
            }
            
            .send-button {
                flex-shrink: 0;
                width: auto;
                min-width: 100px;
            }
        }
        
        /* M√≥viles grandes y tablets portrait */
        @media (min-width: 481px) and (max-width: 767px) {
            .chat-container {
                width: 95%;
                height: 92vh;
                border-radius: 18px;
            }
            
            .chat-header {
                padding: 18px;
                border-radius: 18px 18px 0 0;
            }
            
            .chat-header h1 {
                font-size: 1.4rem;
            }
            
            .chat-messages {
                padding: 18px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message-avatar {
                width: 38px;
                height: 38px;
                font-size: 19px;
            }
            
            .chat-input {
                padding: 18px;
            }
            
            .input-container {
                flex-direction: column;
                gap: 12px;
            }
            
            .send-button {
                width: 100%;
                justify-content: center;
                min-height: 48px;
            }
        }
        
        /* M√≥viles peque√±os - Optimizaci√≥n m√°xima */
        @media (max-width: 480px) {
            .chat-container {
                width: 98%;
                height: 95vh;
                border-radius: 16px;
                margin: 1vh auto;
            }
            
            .chat-header {
                padding: 15px;
                border-radius: 16px 16px 0 0;
            }
            
            .chat-header h1 {
                font-size: 1.3rem;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
                margin-bottom: 12px;
            }
            
            .message-avatar {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .message-content {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .chat-input {
                padding: 15px;
                border-radius: 0 0 16px 16px;
            }
            
            .input-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .message-input {
                min-height: 44px;
                font-size: 16px; /* Evita zoom en iOS */
                border-radius: 8px;
            }
            
            .send-button {
                width: 100%;
                justify-content: center;
                min-height: 48px;
                font-size: 1rem;
                border-radius: 8px;
            }
            
            /* Optimizaci√≥n de acciones en m√≥vil */
            .input-actions {
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px;
                margin-top: 8px;
            }
            
            .action-btn {
                flex: 1;
                min-width: 80px;
                max-width: 120px;
                text-align: center;
                font-size: 0.75rem;
                padding: 8px 6px;
                min-height: 42px;
                border-radius: 6px;
            }
            
            .lang-btn {
                min-width: 70px;
            }
        }
        
        /* Landscape m√≥vil - Optimizaci√≥n especial */
        @media (max-height: 500px) and (orientation: landscape) and (max-width: 768px) {
            .chat-container {
                height: 98vh;
                margin: 1vh auto;
                border-radius: 12px;
            }
            
            .chat-header {
                padding: 10px 20px;
                border-radius: 12px 12px 0 0;
            }
            
            .chat-header h1 {
                font-size: 1.2rem;
            }
            
            .chat-messages {
                padding: 10px 20px;
            }
            
            .chat-input {
                padding: 10px 20px;
                border-radius: 0 0 12px 12px;
            }
            
            .input-container {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            
            .message-input {
                flex: 1;
                min-height: 36px;
            }
            
            .send-button {
                width: auto;
                min-width: 80px;
                min-height: 36px;
                padding: 8px 16px;
            }
            
            .input-actions {
                gap: 4px;
                margin-top: 6px;
            }
            
            .action-btn {
                padding: 6px 8px;
                font-size: 0.7rem;
                min-height: 36px;
            }
        }
        
        @media (max-width: 480px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .back-btn {
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .chat-header {
                padding: 12px;
            }
            
            .chat-header h1 {
                font-size: 1.3rem;
            }
            

            
            .message-content {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .action-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
        }

        /* Modal de Personalizaci√≥n */
        .customize-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .customize-modal-content {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .customize-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .customize-modal-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .close-modal:hover {
            background: var(--hover-bg);
        }

        .customize-modal-body {
            padding: 20px;
        }

        .customize-section {
            margin-bottom: 25px;
        }

        .customize-section h4 {
            margin: 0 0 15px 0;
            color: var(--text-color);
            font-size: 1rem;
        }

        .theme-options, .font-size-controls, .avatar-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .theme-btn, .font-btn, .avatar-btn {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .theme-btn:hover, .font-btn:hover, .avatar-btn:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .theme-btn.active, .font-btn.active, .avatar-btn.active {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
        }

        .theme-btn {
            min-width: 100px;
            font-weight: bold;
        }

        .avatar-btn {
            font-size: 1.2rem;
        }

        /* === ANIMACIONES SUAVES === */
        
        /* Transiciones globales para cambios de tema */
        :root {
            transition: 
                --bg-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                --text-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                --accent-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                --border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                --hover-bg 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Elementos que participan en las transiciones de tema */
        body, .chat-container, .customize-modal-content,
        .message, .chat-header, .chat-input, .action-btn,
        .theme-btn, .font-btn, .avatar-btn {
            transition: 
                background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Modal: Animaci√≥n de entrada */
        .customize-modal {
            backdrop-filter: blur(0px);
            transition: backdrop-filter 0.3s ease-out;
        }
        
        .customize-modal.show {
            backdrop-filter: blur(8px);
        }

        .customize-modal-content {
            transform: scale(0.85) translateY(-30px);
            opacity: 0;
            transition: 
                transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                opacity 0.3s ease-out,
                background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .customize-modal.show .customize-modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Botones: Micro-interacciones */
        .theme-btn, .font-btn, .avatar-btn, .action-btn {
            position: relative;
            overflow: hidden;
            transition: 
                transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Efecto ripple para botones */
        .theme-btn::before, .font-btn::before, .avatar-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .theme-btn:active::before, .font-btn:active::before, .avatar-btn:active::before {
            width: 200px;
            height: 200px;
        }

        /* Hover suave */
        .theme-btn:hover, .font-btn:hover, .avatar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                0 0 20px rgba(var(--accent-color-rgb, 102, 126, 234), 0.3);
        }

        /* Click feedback */
        .theme-btn:active, .font-btn:active, .avatar-btn:active {
            transform: translateY(0) scale(0.96);
        }

        /* Bot√≥n activo con glow animado */
        .theme-btn.active, .font-btn.active, .avatar-btn.active {
            box-shadow: 
                0 0 20px rgba(var(--accent-color-rgb, 102, 126, 234), 0.5),
                0 0 40px rgba(var(--accent-color-rgb, 102, 126, 234), 0.3),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            animation: glow-pulse 2s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from {
                box-shadow: 
                    0 0 20px rgba(var(--accent-color-rgb, 102, 126, 234), 0.5),
                    0 0 40px rgba(var(--accent-color-rgb, 102, 126, 234), 0.3);
            }
            to {
                box-shadow: 
                    0 0 30px rgba(var(--accent-color-rgb, 102, 126, 234), 0.7),
                    0 0 60px rgba(var(--accent-color-rgb, 102, 126, 234), 0.4);
            }
        }

        /* Bot√≥n de personalizar con animaci√≥n especial */
        .customize-btn {
            animation: customize-hint 3s ease-in-out infinite;
        }

        @keyframes customize-hint {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .customize-btn:hover {
            animation: none;
            transform: translateY(-2px) rotate(0deg);
        }

        /* Close button con rotaci√≥n suave */
        .close-modal {
            transition: 
                transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                background-color 0.3s ease;
        }

        .close-modal:hover {
            transform: rotate(90deg) scale(1.1);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Animaci√≥n de carga para cambios de tema */
        .theme-changing {
            position: relative;
            pointer-events: none;
        }

        .theme-changing::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 1s ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Feedback visual para selecci√≥n de avatar */
        .avatar-btn:active {
            animation: avatar-bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes avatar-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1); }
        }

        /* Transici√≥n suave para cambios de font-size */
        .message-content, .chat-header h1, .customize-section h4 {
            transition: font-size 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Loading indicator para operaciones */
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Optimizaci√≥n de performance para animaciones */
        .theme-btn, .font-btn, .avatar-btn, .customize-modal-content {
            will-change: transform, opacity;
        }

        /* Efecto ripple generado din√°micamente */
        @keyframes ripple-effect {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Reduce motion para usuarios que prefieren menos animaci√≥n */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .customize-btn {
                animation: none;
            }
        }

        /* === RESPONSIVE AVANZADO === */
        
        /* Pantallas Ultra-Wide (>1440px) */
        @media (min-width: 1441px) {
            .chat-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 40px;
            }
            
            .customize-modal-content {
                max-width: 600px;
                padding: 0;
            }
            
            .customize-modal-body {
                padding: 30px;
            }
            
            .theme-options, .font-size-controls, .avatar-options {
                gap: 15px;
            }
            
            .theme-btn, .font-btn, .avatar-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            /* Aprovechar el espacio horizontal */
            .input-actions {
                justify-content: center;
                gap: 15px;
            }
            
            .action-btn {
                padding: 12px 18px;
                font-size: 0.95rem;
            }
        }

        /* Tablets en Landscape (1024px-1440px) */
        @media (min-width: 1024px) and (max-width: 1440px) {
            .customize-modal-content {
                max-width: 550px;
            }
            
            .theme-options {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            
            .font-size-controls, .avatar-options {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .input-actions {
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Tablets en Portrait (768px-1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .customize-modal-content {
                width: 85%;
                max-width: 500px;
            }
            
            .customize-modal-header {
                padding: 25px;
            }
            
            .customize-modal-body {
                padding: 25px;
            }
            
            .theme-options {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .font-size-controls {
                display: flex;
                justify-content: space-between;
                gap: 15px;
            }
            
            .avatar-options {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
            
            /* Controles t√°ctiles mejorados */
            .theme-btn, .font-btn, .avatar-btn {
                padding: 15px;
                font-size: 1rem;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            .action-btn {
                padding: 12px 15px;
                min-height: 48px;
                touch-action: manipulation;
            }
        }

        /* M√≥viles Grandes (481px-767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            .customize-modal-content {
                width: 90%;
                margin: 15px;
                max-height: 85vh;
            }
            
            .customize-modal-header {
                padding: 20px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .close-modal {
                position: absolute;
                top: 15px;
                right: 15px;
            }
            
            .theme-options {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .font-size-controls {
                display: flex;
                gap: 8px;
            }
            
            .avatar-options {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            
            .input-actions {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }
            
            .action-btn {
                flex: 1 1 calc(50% - 4px);
                min-width: 120px;
                padding: 10px 8px;
                font-size: 0.85rem;
            }
        }

        /* M√≥viles Peque√±os (<480px) */
        @media (max-width: 480px) {
            .customize-modal-content {
                width: 95%;
                margin: 10px;
                max-height: 90vh;
                border-radius: 8px;
            }
            
            .customize-modal-header {
                padding: 15px;
                border-radius: 8px 8px 0 0;
            }
            
            .customize-modal-header h3 {
                font-size: 1.1rem;
            }
            
            .customize-modal-body {
                padding: 15px;
            }
            
            .customize-section {
                margin-bottom: 20px;
            }
            
            .customize-section h4 {
                font-size: 0.95rem;
                margin-bottom: 12px;
            }
            
            /* Stack vertical para m√≥viles peque√±os */
            .theme-options, .font-size-controls, .avatar-options {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .theme-btn, .font-btn, .avatar-btn {
                width: 100%;
                padding: 12px;
                font-size: 0.9rem;
                min-height: 45px;
                border-radius: 6px;
            }
            
            /* Optimizaci√≥n para pantallas muy peque√±as */
            .input-actions {
                flex-direction: column;
                gap: 6px;
            }
            
            .action-btn {
                width: 100%;
                padding: 10px;
                font-size: 0.8rem;
                min-height: 42px;
            }
            
            /* Gestos t√°ctiles mejorados */
            .theme-btn:active, .font-btn:active, .avatar-btn:active,
            .action-btn:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
        }

        /* Optimizaci√≥n para dispositivos con hover limitado */
        @media (hover: none) and (pointer: coarse) {
            .theme-btn:hover, .font-btn:hover, .avatar-btn:hover,
            .action-btn:hover, .close-modal:hover {
                transform: none;
            }
            
            .theme-btn:active, .font-btn:active, .avatar-btn:active {
                background: var(--accent-color);
                color: white;
                transform: scale(0.95);
            }
        }

        /* Orientaci√≥n Landscape en m√≥viles */
        @media (max-height: 500px) and (orientation: landscape) {
            .customize-modal-content {
                max-height: 95vh;
                overflow-y: auto;
            }
            
            .customize-modal-header {
                padding: 10px 20px;
            }
            
            .customize-modal-body {
                padding: 15px 20px;
            }
            
            .customize-section {
                margin-bottom: 15px;
            }
            
            .theme-options, .avatar-options {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .font-size-controls {
                display: flex;
                gap: 8px;
            }
        }

        @media (max-width: 768px) {
            .customize-modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .theme-options, .font-size-controls, .avatar-options {
                flex-direction: column;
            }
            
            .theme-btn, .font-btn, .avatar-btn {
                width: 100%;
            }
        }

        /* === CHROME AI TOOLS STYLES === */
        .chrome-ai-tools {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .ai-tool-btn {
            display: flex !important;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0, 245, 255, 0.1) !important;
            border: 1px solid rgba(0, 245, 255, 0.3) !important;
            border-radius: 12px;
            color: var(--text-primary) !important;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ai-tool-btn::after {
            content: 'üîµ';
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 12px;
            opacity: 0.7;
        }

        .ai-tool-btn.chrome-ai-full::after {
            content: 'üß†';
            color: #00ff00;
        }

        .ai-tool-btn.chrome-ai-prompt::after {
            content: 'üîµ';
            color: #00ccff;
        }

        .ai-tool-btn.gemini-fallback::after {
            content: 'üåê';
            color: #ff9500;
        }

        .ai-tool-btn:hover::after {
            animation: pulse-brain 1.5s infinite;
        }

        @keyframes pulse-brain {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Status indicator styling */
        #ai-status-indicator {
            position: relative;
            overflow: hidden;
        }

        #ai-status-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ai-tool-btn {
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 8px !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 60px !important;
        }

        .ai-tool-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            border-color: rgba(0, 245, 255, 0.5);
            box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
            transform: translateY(-2px);
        }

        .ai-tool-icon {
            font-size: 1.5rem;
            min-width: 24px;
            text-align: center;
        }

        .ai-tool-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .ai-tool-info strong {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .ai-tool-info small {
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.8;
            line-height: 1.2;
        }

        /* Responsive design para herramientas AI */
        @media (max-width: 768px) {
            .ai-tool-btn {
                padding: 10px 12px;
                gap: 10px;
            }
            
            .ai-tool-icon {
                font-size: 1.3rem;
            }
            
            .ai-tool-info strong {
                font-size: 0.9rem;
            }
            
            .ai-tool-info small {
                font-size: 0.75rem;
            }
        }

        /* === MODALES DE IA === */
        
        .ai-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .ai-modal-content {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .ai-modal.show .ai-modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .ai-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--bg-color), var(--hover-bg));
            border-radius: 16px 16px 0 0;
        }

        .ai-modal-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.4rem;
            font-weight: 600;
        }

        .close-ai-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-ai-modal:hover {
            background: var(--hover-bg);
            transform: rotate(90deg);
        }

        .ai-modal-body {
            padding: 24px;
        }

        .ai-section {
            margin-bottom: 24px;
        }

        .ai-section label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .ai-section textarea,
        .ai-section select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--hover-bg);
            color: var(--text-color);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 120px;
        }

        .ai-section select {
            min-height: auto;
            height: 48px;
            cursor: pointer;
        }

        .ai-section textarea:focus,
        .ai-section select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.2);
        }

        .translator-languages {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: end;
        }

        .language-group {
            display: flex;
            flex-direction: column;
        }

        .language-swap {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swap-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .swap-btn:hover {
            transform: rotate(180deg);
            background: var(--hover-bg);
        }

        .ai-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .ai-btn {
            padding: 12px 24px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--hover-bg);
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-btn:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .ai-btn.primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .ai-btn.primary:hover {
            background: var(--hover-bg);
            color: var(--accent-color);
        }

        .ai-btn.secondary {
            background: transparent;
            border-color: var(--border-color);
        }

        .ai-result {
            margin-top: 24px;
            padding: 20px;
            background: var(--hover-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .ai-result h4 {
            margin: 0 0 16px 0;
            color: var(--accent-color);
            font-size: 1.1rem;
        }

        .ai-output {
            background: var(--bg-color);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Loading state */
        .ai-loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-color);
        }

        .ai-loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive para modales de IA */
        @media (max-width: 768px) {
            .ai-modal-content {
                width: 95%;
                margin: 20px;
                max-height: 90vh;
            }
            
            .ai-modal-header {
                padding: 20px;
            }
            
            .ai-modal-body {
                padding: 20px;
            }
            
            .translator-languages {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .language-swap {
                order: -1;
            }
            
            .swap-btn {
                transform: rotate(90deg);
            }
            
            .ai-actions {
                flex-direction: column;
            }
            
            .ai-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    
    <canvas id="neural-canvas"></canvas>
    <a href="#main-chat" class="skip-link">{{ translate('welcome') }}</a>
    <div id="chat-container" role="main" aria-label="Chat principal">
        <!-- Skip to main content for accessibility -->
        <a href="#chat-main" class="skip-link" aria-label="Saltar al contenido principal del chat">Saltar al chat</a>
        
        <nav aria-label="Navegaci√≥n principal">
            <a href="/" class="back-btn" aria-label="Volver a la p√°gina principal">‚Üê Volver</a>
        </nav>


        <!-- √önico contenedor requerido por E2E Selenium y la app -->
        <div id="chatContainer" class="chat-container" role="main">
            <header class="chat-header">
                <div class="chat-header-content">
                    <h1><span class="title-emoji">ü§ñ</span> <span class="title-text">Gemini AI Chat</span></h1>
                    <div class="chat-status" role="status" aria-live="polite">
                        <div class="status-dot" aria-hidden="true"></div>
                        <span>Asistente en l√≠nea</span>
                    </div>
                </div>
            </header>
            <section class="chat-messages" id="messages" role="log" aria-live="polite" aria-label="Historial de conversaci√≥n">
            </section>
            <div class="typing-indicator" id="typing" role="status" aria-live="polite" aria-label="Indicador de escritura">
                <span>El asistente est√° escribiendo</span>
                <div class="typing-dots" aria-hidden="true">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <section class="chat-input" aria-label="√Årea de entrada de mensajes">
                <form id="chat-form" class="input-container" onsubmit="sendMessage(); return false;">
                    <div class="input-wrapper">
                        <label for="messageInput" class="sr-only">Escribe tu mensaje</label>
                        <textarea id="messageInput" placeholder="Escribe tu mensaje aqu√≠..." maxlength="1000" aria-describedby="charCounter" aria-required="true" autocomplete="off" rows="1"></textarea>
                        <div class="char-counter" id="charCounter" aria-live="polite">0/1000</div>
                    </div>
                    <button type="submit" class="send-button" id="sendButton" aria-label="Enviar mensaje">
                        <span>Enviar</span>
                        <span aria-hidden="true">üì§</span>
                    </button>
                </form>
                <div class="input-actions" role="toolbar" aria-label="Acciones del chat">
                    <button class="action-btn" aria-label="Limpiar historial del chat" tabindex="0">üóëÔ∏è Limpiar chat</button>
                    <button class="action-btn" aria-label="Exportar conversaci√≥n" tabindex="0" id="exportChatBtn">üíæ Exportar</button>
    <!-- Modal de selecci√≥n de formato de exportaci√≥n -->
    <div id="exportFormatModal" class="ai-modal" style="display: none; z-index: 9999;">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>Exportar Conversaci√≥n</h3>
                <button class="close-ai-modal" data-modal="exportFormatModal">&times;</button>
            </div>
            <div class="ai-modal-body">
                <p>Selecciona el formato para exportar tu conversaci√≥n:</p>
                <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                    <button class="export-format-btn" data-format="txt">TXT</button>
                    <button class="export-format-btn" data-format="md">Markdown</button>
                    <button class="export-format-btn" data-format="pdf">PDF</button>
                </div>
            </div>
        </div>
    </div>
                    <button class="action-btn" aria-label="Activar o desactivar s√≠ntesis de voz" tabindex="0">üé§ Voz</button>
                    <button class="action-btn" aria-label="Subir archivo" tabindex="0">üìé Archivo</button>
                    <button class="action-btn lang-btn" data-lang="es" aria-label="Cambiar a espa√±ol" tabindex="0">üá™üá∏ Espa√±ol</button>
                    <button class="action-btn lang-btn" data-lang="en" aria-label="Cambiar a ingl√©s" tabindex="0">üá¨üáß English</button>
                    <button class="action-btn customize-btn" aria-label="Personalizar interfaz" tabindex="0">‚öôÔ∏è Personalizar</button>
                </div>
                <input type="file" id="fileInput" style="display: none;" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple aria-label="Seleccionar archivos para subir">
            </section>
        </div>
    </div>
    <!-- El selector de idioma se ha movido a los botones de acci√≥n del chat -->
    <script>
        // === GLOBAL ERROR HANDLERS ===
        // Prevent uncaught promise rejections and async listener errors
        window.addEventListener('unhandledrejection', function(event) {
            console.warn('Unhandled promise rejection:', event.reason);
            event.preventDefault(); // Prevent the default browser behavior
        });
        
        window.addEventListener('error', function(event) {
            if (event.message && event.message.includes('message channel closed')) {
                console.warn('Chrome extension message channel error (ignored):', event.message);
                event.preventDefault();
                return false;
            }
        });

        // === CONFIGURACI√ìN OPTIMIZADA Y VARIABLES GLOBALES ===
        let messagesContainer, messageInput, sendButton, typingIndicator, charCounter;
        let currentUtterance = null;
        let isPaused = false;
        let pendingText = '';
        let isVoiceEnabled = false;
        let chatHistory = [];
        let isLoading = false;
        let currentMessageId = 0;
        let lastScrollPosition = 0;
        let autoScrollEnabled = true;
        let retryCount = 0;
        let conversationId = 'session_' + Date.now(); // ID √∫nico para la conversaci√≥n actual
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;
        const MAX_MESSAGE_LENGTH = 4000;
        const TYPING_SPEED = 30;
        const particles = [];
        const MAX_PARTICLES = 30; // Reducido para mejor rendimiento
        let animationId;
        let lastParticleTime = 0;
        const PARTICLE_INTERVAL = 150; // Aumentado para reducir carga
        
        // Chrome Built-in AI variables
        let chromeAI = null;
        
        // === SISTEMA DE TRADUCCIONES E IDIOMAS ===
        const translations = {
            es: {
                // Botones de an√°lisis de imagen
                analyzeButton: 'üîç Analizar',
                describeButton: 'üìù Describir',
                colorsButton: 'üé® Colores',
                textButton: 'üìñ Texto',
                interpretButton: 'üß† Interpretar',
                
                // Mensajes de notificaci√≥n
                imageUploaded: 'üì∏ Imagen cargada exitosamente',
                imageUploadedMultiple: 'üì∏ {count} imagen(es) cargada(s)',
                imageUploadedDragDrop: 'üì∏ {count} imagen(es) cargada(s) por drag & drop',
                onlyImagesAllowed: '‚ö†Ô∏è Solo se pueden arrastrar archivos de imagen',
                invalidImageFile: '‚ö†Ô∏è {filename} no es una imagen v√°lida',
                
                // Indicador de drag & drop
                dropIndicator: 'üì∏ Suelta aqu√≠ tu imagen para analizarla',
                
                // Prompts de an√°lisis
                analyzePrompt: 'Analiza esta imagen en detalle',
                describePrompt: 'Describe detalladamente esta imagen',
                colorsPrompt: 'Analiza los colores y la paleta de esta imagen',
                textPrompt: 'Extrae y transcribe todo el texto visible en esta imagen',
                interpretPrompt: 'Interpreta el significado y contexto de esta imagen',
                
                // Contexto de imagen para IA
                contextMessage: 'El usuario ha subido una imagen llamada "{imageName}" y est√° preguntando: "{message}". Por favor analiza la imagen y responde a su pregunta.',
                
                // Botones de modo AI
                aiModeHybrid: 'üîÑ H√≠brido',
                aiModeServer: '‚òÅÔ∏è Nube', 
                aiModeChrome: 'üß† Local',
                aiModeMainButton: 'Chrome AI',
                aiModeHybridLabel: 'Modo AI H√≠brido - Selecci√≥n inteligente autom√°tica',
                aiModeServerLabel: 'Modo AI Servidor - Gemini avanzado en la nube',
                aiModeChromeLabel: 'Modo AI Chrome - Procesamiento local privado',
                aiModeMainLabel: 'Selector de modo Chrome AI',
                aiModeChanged: 'ü§ñ Modo AI: {mode}'
            },
            en: {
                // Botones de an√°lisis de imagen
                analyzeButton: 'üîç Analyze',
                describeButton: 'üìù Describe',
                colorsButton: 'üé® Colors',
                textButton: 'üìñ Text',
                interpretButton: 'üß† Interpret',
                
                // Mensajes de notificaci√≥n
                imageUploaded: 'üì∏ Image uploaded successfully',
                imageUploadedMultiple: 'üì∏ {count} image(s) uploaded',
                imageUploadedDragDrop: 'üì∏ {count} image(s) uploaded by drag & drop',
                onlyImagesAllowed: '‚ö†Ô∏è Only image files can be dragged',
                invalidImageFile: '‚ö†Ô∏è {filename} is not a valid image',
                
                // Indicador de drag & drop
                dropIndicator: 'üì∏ Drop your image here to analyze it',
                
                // Prompts de an√°lisis
                analyzePrompt: 'Analyze this image in detail',
                describePrompt: 'Describe this image in detail',
                colorsPrompt: 'Analyze the colors and palette of this image',
                textPrompt: 'Extract and transcribe all visible text in this image',
                interpretPrompt: 'Interpret the meaning and context of this image',
                
                // Contexto de imagen para IA
                contextMessage: 'The user has uploaded an image called "{imageName}" and is asking: "{message}". Please analyze the image and respond to their question.',
                
                // Botones de modo AI
                aiModeHybrid: 'üîÑ Hybrid',
                aiModeServer: '‚òÅÔ∏è Cloud', 
                aiModeChrome: 'üß† Local',
                aiModeMainButton: 'Chrome AI',
                aiModeHybridLabel: 'Hybrid AI Mode - Smart automatic selection',
                aiModeServerLabel: 'Server AI Mode - Advanced Gemini in the cloud',
                aiModeChromeLabel: 'Chrome AI Mode - Private local processing',
                aiModeMainLabel: 'Chrome AI mode selector',
                aiModeChanged: 'ü§ñ AI Mode: {mode}'
            }
        };
        
        // Variables de contexto de imagen
        let currentImageContext = null;
        let currentImageName = '';
        let currentImageData = '';
        
        // Funci√≥n para obtener el idioma actual
        function getCurrentLanguage() {
            return document.documentElement.lang || 'es';
        }
        
        // Funci√≥n para obtener texto traducido
        function t(key, params = {}) {
            const lang = getCurrentLanguage();
            let text = translations[lang]?.[key] || translations.es[key] || key;
            
            // Reemplazar par√°metros {key} en el texto
            Object.keys(params).forEach(param => {
                text = text.replace(new RegExp(`\\{${param}\\}`, 'g'), params[param]);
            });
            
            return text;
        }
        
        // Chrome Built-in AI variables
        let chromeAIAvailable = false;
        let preferChromeAI = false; // User preference for Chrome AI vs Server AI
        let currentAIMode = 'hybrid'; // 'chrome', 'server', 'hybrid'
        
        // Image context management
        let uploadedImages = []; // Store uploaded images with metadata
        let currentImageIndex = 0; // Track current image for analysis
        
        // requestAnimationFrame loop to guarantee input is always enabled
        function forceEnableInput() {
            if (messageInput) {
                if (messageInput.disabled) {
                    console.warn('Input was disabled, forcibly enabling.');
                    messageInput.disabled = false;
                }
                requestAnimationFrame(forceEnableInput);
            }
        }
        
        // Cache de elementos DOM para evitar b√∫squedas repetidas
        const domCache = {
            chatMessages: null,
            messageInput: null,
            sendButton: null,
            typingIndicator: null,
            particleContainer: null
        };
        
        // Configuraci√≥n de rendimiento
        const PERFORMANCE_CONFIG = {
            enableParticles: true,
            enableAnimations: true,
            enableSmoothScroll: true,
            debounceDelay: 300,
            throttleDelay: 16 // ~60fps
        };
        
        // M√©tricas de rendimiento del cliente
        let clientMetrics = {
            messagesCount: 0,
            averageResponseTime: 0,
            lastMessageTime: 0,
            cacheHits: 0
        };
        

        
        // === FUNCIONES DE UTILIDAD OPTIMIZADAS ===
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // Cache de elementos DOM
        function initDOMCache() {
            domCache.chatMessages = document.getElementById('messages');
            domCache.messageInput = document.getElementById('messageInput');
            domCache.sendButton = document.getElementById('sendButton');
            domCache.typingIndicator = document.getElementById('typing');
            domCache.particleContainer = document.body;
        }
        
        // Funci√≥n optimizada para obtener elementos del DOM
        function getElement(key) {
            if (!domCache[key]) {
                switch(key) {
                    case 'chatMessages':
                        domCache[key] = document.getElementById('messages');
                        break;
                    case 'messageInput':
                        domCache[key] = document.getElementById('messageInput');
                        break;
                    case 'sendButton':
                        domCache[key] = document.getElementById('sendButton');
                        break;
                    case 'typingIndicator':
                        domCache[key] = document.getElementById('typing');
                        break;
                    case 'particleContainer':
                        domCache[key] = document.body;
                        break;
                }
            }
            return domCache[key];
        }
        
        // Funci√≥n para limpiar cache DOM cuando sea necesario
        function clearDOMCache() {
            Object.keys(domCache).forEach(key => {
                domCache[key] = null;
            });
        }
        
        // Funciones principales (deben estar en scope global)
        function addMessage(text, sender, timestamp = null) {
            try {
                if (!messagesContainer) {
                    console.error('messagesContainer no est√° disponible');
                    return;
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                
                // Emojis mejorados para el bot y usuario
                if (sender === 'user') {
                    avatar.innerHTML = 'üë®‚Äçüíª';
                } else {
                    // Usar el avatar personalizado guardado
                    avatar.innerHTML = customization.currentAvatar || 'ü§ñ';
                }
                
                const contentWrapper = document.createElement('div');
                
                const content = document.createElement('div');
                content.className = 'message-content';
                
                // Procesar texto seg√∫n el remitente
                if (sender === 'bot') {
                    content.innerHTML = formatBotResponse(text);
                } else {
                    content.textContent = text;
                }
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = timestamp || new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                contentWrapper.appendChild(content);
                contentWrapper.appendChild(timeDiv);
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentWrapper);
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Guardar en historial
                chatHistory.push({
                    text: text,
                    sender: sender,
                    timestamp: timestamp || new Date().toISOString()
                });
                
                // Animaci√≥n de entrada
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    messageDiv.style.transition = 'all 0.3s ease';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 100);
            } catch (error) {
                console.error('Error al agregar mensaje:', error);
            }
        }
        
        function formatBotResponse(text) {
            // Funci√≥n para formatear respuestas del bot con Markdown b√°sico
            if (!text) return '';
            
            // Escapar HTML para seguridad
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Procesar Markdown b√°sico
            formatted = formatted
                // T√≠tulos
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                
                // Negrita
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                
                // Cursiva
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                
                // C√≥digo en l√≠nea
                .replace(/`(.+?)`/g, '<code>$1</code>')
                
                // Listas con vi√±etas
                .replace(/^\* (.+$)/gim, '<li>$1</li>')
                
                // Saltos de l√≠nea
                .replace(/\n/g, '<br>');
            
            // Envolver listas en <ul>
            formatted = formatted.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            // Limpiar listas anidadas incorrectas
            formatted = formatted.replace(/<\/ul>\s*<ul>/g, '');
            
            return formatted;
        }
        
        function autoResizeTextarea(textarea) {
            // Funci√≥n para auto-redimensionar el textarea
            if (!textarea) return;
            
            // Resetear altura para obtener el scrollHeight correcto
            textarea.style.height = 'auto';
            
            // Calcular nueva altura basada en el contenido
            const newHeight = Math.max(54, Math.min(120, textarea.scrollHeight));
            
            // Aplicar nueva altura
            textarea.style.height = newHeight + 'px';
        }
        
        function showTyping() {
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Actualizar estado del bot
                const statusText = document.querySelector('.chat-status span');
                if (statusText) statusText.textContent = 'Escribiendo...';
            }
        }
        
        function hideTyping() {
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
                
                // Restaurar estado del bot
                const statusText = document.querySelector('.chat-status span');
                if (statusText) statusText.textContent = 'Asistente en l√≠nea';
            }
        }
        
        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const chatContainer = document.getElementById('chat-container') || document.body;
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                chatContainer.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop area
            ['dragenter', 'dragover'].forEach(eventName => {
                chatContainer.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                chatContainer.addEventListener(eventName, unhighlight, false);
            });
            
            // Handle dropped files
            chatContainer.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                if (isDraggedFileImage(e)) {
                    chatContainer.style.backgroundColor = 'rgba(0, 212, 255, 0.1)';
                    chatContainer.style.border = '2px dashed var(--accent-color)';
                    
                    // Show drop indicator
                    showDropIndicator();
                }
            }
            
            function unhighlight(e) {
                chatContainer.style.backgroundColor = '';
                chatContainer.style.border = '';
                hideDropIndicator();
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // Filter for images only
                    const imageFiles = Array.from(files).filter(file => 
                        file.type.startsWith('image/')
                    );
                    
                    if (imageFiles.length > 0) {
                        handleFileUpload(imageFiles);
                        showNotification(t('imageUploadedDragDrop', { count: imageFiles.length }), 'success');
                    } else {
                        showNotification(t('onlyImagesAllowed'), 'warning');
                    }
                }
            }
            
            function isDraggedFileImage(e) {
                const types = e.dataTransfer.types;
                return types.includes('Files');
            }
            
            function showDropIndicator() {
                if (document.getElementById('drop-indicator')) return;
                
                const indicator = document.createElement('div');
                indicator.id = 'drop-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 212, 255, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    font-size: 18px;
                    font-weight: bold;
                    z-index: 10000;
                    pointer-events: none;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 8px 32px rgba(0, 212, 255, 0.3);
                `;
                indicator.innerHTML = t('dropIndicator');
                document.body.appendChild(indicator);
            }
            
            function hideDropIndicator() {
                const indicator = document.getElementById('drop-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        // Handle file upload for drag & drop and button click
        function handleFileUpload(files) {
            const fileArray = Array.isArray(files) ? files : Array.from(files);
            
            fileArray.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    processImageFile(file, index > 0); // Add spacing for multiple files
                } else {
                    showNotification(t('invalidImageFile', { filename: file.name }), 'warning');
                }
            });
        }
        
        // === CHROME BUILT-IN AI INTEGRATION ===
        
        async function initializeChromeAI() {
            try {
                if (typeof ChromeAIManager === 'undefined') {
                    console.log('Chrome AI Manager not available');
                    chromeAIAvailable = false;
                } else {
                    chromeAI = new ChromeAIManager();
                    chromeAIAvailable = await chromeAI.initialize();
                }
                
                // Always add AI mode selector, regardless of Chrome AI availability
                addAIModeSelector();
                
                // Actualizar indicadores de estado
                updateAIStatusIndicator();
                updateAIButtonsVisibility();
                
                if (chromeAIAvailable) {
                    console.log('üöÄ Chrome Built-in AI Local disponible');
                    
                    // Check which APIs are available (simple check)
                    const capabilities = chromeAI.getCapabilities();
                    const hasPrompt = capabilities.prompt || false;
                    
                    if (hasPrompt) {
                        showNotification('üß† Chrome AI Local listo para usar offline!', 'success');
                    } else {
                        showNotification('üß† Chrome Built-in AI detectado. Inicializando...', 'info');
                    }
                    
                } else {
                    console.log('Chrome Built-in AI not available on this device');
                    showNotification('‚ÑπÔ∏è Chrome Built-in AI no disponible. Usando solo Gemini API.', 'info');
                }
                
            } catch (error) {
                console.error('Failed to initialize Chrome AI:', error);
                chromeAIAvailable = false;
                // Still add the selector even if there's an error
                addAIModeSelector();
            }
        }
        
        function addAIModeSelector() {
            // Add AI mode dropdown to the existing input-actions toolbar
            const inputActions = document.querySelector('.input-actions');
            if (!inputActions) return;
            
            // Check if AI mode button already exists
            if (document.querySelector('.ai-mode-dropdown')) return;
            
            // Create AI mode dropdown container
            const aiModeContainer = document.createElement('div');
            aiModeContainer.className = 'ai-mode-dropdown';
            aiModeContainer.style.cssText = `
                position: relative;
                display: inline-block;
            `;
            
            // Create main Chrome AI button
            const mainButton = document.createElement('button');
            mainButton.className = 'action-btn ai-mode-main-btn';
            mainButton.setAttribute('aria-label', t('aiModeMainLabel'));
            mainButton.setAttribute('tabindex', '0');
            mainButton.innerHTML = `ü§ñ ${t('aiModeMainButton')} <span style="margin-left: 4px;">‚ñº</span>`;
            
            // Create dropdown menu
            const dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'ai-mode-menu';
            dropdownMenu.style.cssText = `
                position: absolute;
                bottom: 100%;
                left: 0;
                background: rgba(0, 0, 0, 0.95);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 8px;
                padding: 8px 0;
                min-width: 180px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                z-index: 1000;
                display: none;
                margin-bottom: 8px;
            `;
            
            // Create menu options
            const menuOptions = [
                {
                    mode: 'hybrid',
                    label: t('aiModeHybrid'),
                    description: getCurrentLanguage() === 'es' ? 'Selecci√≥n inteligente autom√°tica' : 'Smart automatic selection'
                },
                {
                    mode: 'server',
                    label: t('aiModeServer'),
                    description: getCurrentLanguage() === 'es' ? 'Gemini avanzado en la nube' : 'Advanced Gemini in the cloud'
                },
                {
                    mode: 'chrome',
                    label: t('aiModeChrome'),
                    description: getCurrentLanguage() === 'es' ? 'Procesamiento local privado' : 'Private local processing'
                }
            ];
            
            menuOptions.forEach(option => {
                const menuItem = document.createElement('div');
                menuItem.className = 'ai-mode-menu-item';
                menuItem.setAttribute('data-mode', option.mode);
                menuItem.style.cssText = `
                    padding: 8px 16px;
                    cursor: pointer;
                    color: #fff;
                    font-size: 14px;
                    transition: background-color 0.2s ease;
                    border-left: 3px solid transparent;
                `;
                
                menuItem.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 2px;">${option.label}</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.7);">${option.description}</div>
                `;
                
                // Add hover and click events
                menuItem.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(0, 212, 255, 0.2)';
                    this.style.borderLeftColor = 'var(--accent-color)';
                });
                
                menuItem.addEventListener('mouseleave', function() {
                    if (this.getAttribute('data-mode') !== currentAIMode) {
                        this.style.backgroundColor = 'transparent';
                        this.style.borderLeftColor = 'transparent';
                    }
                });
                
                menuItem.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    
                    // Check Chrome AI availability
                    if (mode === 'chrome' && !chromeAIAvailable) {
                        showNotification('üö´ Chrome Built-in AI no est√° disponible. Usa Chrome Canary con flags habilitados.', 'warning');
                        return;
                    }
                    
                    // Update current mode
                    currentAIMode = mode;
                    localStorage.setItem('preferredAIMode', currentAIMode);
                    
                    // Update UI
                    updateAIModeDisplay();
                    
                    // Hide dropdown
                    dropdownMenu.style.display = 'none';
                    
                    // Show notification
                    const modeNames = {
                        'hybrid': getCurrentLanguage() === 'es' ? 'H√≠brido (Inteligente)' : 'Hybrid (Smart)',
                        'server': getCurrentLanguage() === 'es' ? 'Servidor (Nube)' : 'Server (Cloud)',
                        'chrome': getCurrentLanguage() === 'es' ? 'Chrome (Local)' : 'Chrome (Local)'
                    };
                    showNotification(t('aiModeChanged', { mode: modeNames[mode] }), 'success');
                });
                
                dropdownMenu.appendChild(menuItem);
            });
            
            // Add click event to main button
            mainButton.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = dropdownMenu.style.display === 'block';
                dropdownMenu.style.display = isVisible ? 'none' : 'block';
                
                // Update arrow direction
                const arrow = this.querySelector('span');
                arrow.textContent = isVisible ? '‚ñº' : '‚ñ≤';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                dropdownMenu.style.display = 'none';
                const arrow = mainButton.querySelector('span');
                if (arrow) arrow.textContent = '‚ñº';
            });
            
            // Assemble the dropdown
            aiModeContainer.appendChild(mainButton);
            aiModeContainer.appendChild(dropdownMenu);
            
            // Insert before language buttons
            const langButtons = inputActions.querySelector('.lang-btn');
            if (langButtons) {
                inputActions.insertBefore(aiModeContainer, langButtons);
            } else {
                inputActions.appendChild(aiModeContainer);
            }
            
            // Load saved preference and update display
            const savedMode = localStorage.getItem('preferredAIMode');
            if (savedMode && ['chrome', 'server', 'hybrid'].includes(savedMode)) {
                currentAIMode = savedMode;
            }
            updateAIModeDisplay();
        }
        
        // Function to update AI mode display
        function updateAIModeDisplay() {
            const mainButton = document.querySelector('.ai-mode-main-btn');
            const menuItems = document.querySelectorAll('.ai-mode-menu-item');
            
            if (!mainButton) return;
            
            // Keep the button text always as "Chrome AI" - don't change it
            mainButton.innerHTML = `ü§ñ ${t('aiModeMainButton')} <span style="margin-left: 4px;">‚ñº</span>`;
            
            // Update main button style based on selection
            if (currentAIMode && currentAIMode !== 'hybrid') {
                mainButton.style.background = 'rgba(0, 255, 136, 0.2)';
                mainButton.style.borderColor = 'rgba(0, 255, 136, 0.5)';
                mainButton.style.color = 'var(--success-color)';
            } else {
                mainButton.style.background = 'rgba(0, 245, 255, 0.1)';
                mainButton.style.borderColor = 'rgba(0, 245, 255, 0.3)';
                mainButton.style.color = 'var(--text-secondary)';
            }
            
            // Update menu items
            menuItems.forEach(item => {
                const mode = item.getAttribute('data-mode');
                
                if (mode === currentAIMode) {
                    item.style.backgroundColor = 'rgba(0, 212, 255, 0.3)';
                    item.style.borderLeftColor = 'var(--accent-color)';
                } else {
                    item.style.backgroundColor = 'transparent';
                    item.style.borderLeftColor = 'transparent';
                }
                
                // Handle Chrome AI availability
                if (mode === 'chrome' && !chromeAIAvailable) {
                    item.style.opacity = '0.5';
                    item.style.cursor = 'not-allowed';
                    const label = item.querySelector('div:first-child');
                    if (label) {
                        label.textContent = t('aiModeChrome') + ' (N/A)';
                    }
                } else {
                    item.style.opacity = '1';
                    item.style.cursor = 'pointer';
                }
            });
        }
        
        function showAIDownloadProgress(progress) {
            // Show download progress for Chrome AI model
            const existingProgress = document.getElementById('ai-download-progress');
            if (existingProgress) {
                existingProgress.remove();
            }
            
            if (progress >= 100) return;
            
            const progressContainer = document.createElement('div');
            progressContainer.id = 'ai-download-progress';
            progressContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                backdrop-filter: blur(10px);
                z-index: 1000;
                font-size: 14px;
                min-width: 250px;
            `;
            
            progressContainer.innerHTML = `
                <div style="margin-bottom: 8px;">üß† Downloading Chrome AI Model...</div>
                <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                    <div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.3s ease;"></div>
                </div>
                <div style="margin-top: 4px; font-size: 12px; text-align: center;">${Math.round(progress)}%</div>
            `;
            
            document.body.appendChild(progressContainer);
            
            if (progress >= 100) {
                setTimeout(() => {
                    progressContainer.remove();
                    showNotification('‚úÖ Chrome AI Model ready!', 'success');
                }, 1000);
            }
        }
        
        async function sendMessageWithChromeAI(message) {
            try {
                if (!chromeAI || !chromeAIAvailable) {
                    throw new Error('Chrome AI not available');
                }
                
                // Show initialization message on first use
                if (!chromeAI.promptSession) {
                    showNotification('üöÄ Activando Chrome AI Local...', 'info');
                }
                
                console.log('üß† Sending message to Chrome AI Local:', message);
                
                // Simple Chrome AI call without extra options
                const response = await chromeAI.prompt(message, { 
                    streaming: false
                });
                
                console.log('üß† Chrome AI Local response received:', response);
                
                if (response && response.trim()) {
                    addMessage(response, 'bot');
                    return response;
                }
                
                throw new Error('No valid response from Chrome AI');
                
            } catch (error) {
                console.error('‚ùå Chrome AI Local error:', error);
                // Re-throw to trigger fallback
                throw new Error(`Chrome AI failed: ${error.message}`);
            }
        }
        
        function shouldUseChromeAI(message) {
            // Smart routing logic based on message complexity and AI mode
            switch (currentAIMode) {
                case 'chrome':
                    return chromeAIAvailable;
                case 'server':
                    return false;
                case 'hybrid':
                    // Optimized: More aggressive Chrome AI usage for speed
                    if (!chromeAIAvailable) return false;
                    
                    // Use Chrome AI for most queries (faster decision)
                    const shouldUseCloud = message.length > 300 || 
                                         message.includes('imagen') || 
                                         message.includes('image') ||
                                         message.includes('analiza') ||
                                         message.includes('analyze') ||
                                         message.includes('c√≥digo') ||
                                         message.includes('code') ||
                                         message.includes('programm');
                    
                    return !shouldUseCloud; // Default to Chrome AI unless complex
                default:
                    return false;
            }
        }
        
        // === ENV√çO DE MENSAJES OPTIMIZADO ===
        let isProcessingMessage = false; // Flag to prevent duplicate processing
        
        async function sendMessage() {
            const messageInput = getElement('messageInput') || document.getElementById('messageInput');
            const sendButton = getElement('sendButton') || document.getElementById('sendButton');
            
            if (!messageInput || !sendButton) return;
            
            const message = messageInput.value.trim();
            
            if (!message || isLoading || isProcessingMessage) return;
            
            if (message.length > 1000) {
                showNotification('El mensaje es demasiado largo (m√°ximo 1000 caracteres)', 'warning');
                return;
            }

            // Set processing flag
            isProcessingMessage = true;
            const startTime = performance.now();
            
            // Solo deshabilitar el bot√≥n, nunca el input
            isLoading = true;
            // Forzar input siempre habilitado
            messageInput.disabled = false;
            sendButton.disabled = true;
            sendButton.innerHTML = '<span>Enviando...</span><span>‚è≥</span>';
            
            // Agregar mensaje del usuario
            addMessage(message, 'user');
            messageInput.value = '';
            autoResizeTextarea(messageInput); // Resetear tama√±o del textarea
            updateCharCounter();
            
            // Mostrar indicador de escritura
            showTyping();
            
            try {
                // Check if we should use Chrome AI
                if (shouldUseChromeAI(message)) {
                    console.log('üß† Using Chrome Built-in AI for response');
                    
                    try {
                        const chromeResponse = await sendMessageWithChromeAI(message);
                        
                        // Actualizar m√©tricas de rendimiento
                        const responseTime = performance.now() - startTime;
                        updateClientMetrics(responseTime);
                        
                        hideTyping();
                        
                        if (chromeResponse) {
                            retryCount = 0;
                            
                            // S√≠ntesis de voz si est√° habilitada
                            if (isVoiceEnabled && 'speechSynthesis' in window) {
                                speakText(chromeResponse);
                            }
                            
                            // Success with Chrome AI, return early
                            return;
                        }
                        
                    } catch (chromeError) {
                        console.warn('Chrome AI failed, falling back to server:', chromeError);
                        // Fall through to server AI
                    }
                }
                
                console.log('‚òÅÔ∏è Using Server AI for response');
                
                const apiUrl = '/api/chat/send';
                
                // Prepare message payload with image context if needed
                const messagePayload = { 
                    message: message,
                    conversation_id: conversationId || 'default',
                    stream: false,
                    language: getCurrentLanguage() // Agregar idioma seleccionado
                };
                
                // Add image context if user is asking about an image
                if (hasImageAnalysisRequest(message) && uploadedImages.length > 0) {
                    const imageContext = getCurrentImageContext();
                    if (imageContext) {
                        messagePayload.image_context = {
                            has_image: true,
                            image_name: imageContext.imageName,
                            image_data: imageContext.imageData,
                            context_message: t('contextMessage', { 
                                imageName: imageContext.imageName, 
                                message: message 
                            })
                        };
                        
                        // Mark image as analyzed
                        uploadedImages[currentImageIndex].analyzed = true;
                        
                        console.log('üñºÔ∏è Including image context in request');
                    }
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(messagePayload),
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Actualizar m√©tricas de rendimiento
                const responseTime = performance.now() - startTime;
                updateClientMetrics(responseTime);
                
                hideTyping();
                
                // =================== C√ìDIGO CORREGIDO ===================
                if (data.response) {
                    // Usamos 'data.response' directamente como devuelve nuestra API
                    addMessage(data.response, 'bot');
                    retryCount = 0; // Reset retry count on success
                    
                    // S√≠ntesis de voz si est√° habilitada
                    if (isVoiceEnabled && 'speechSynthesis' in window) {
                        speakText(data.response);
                    }
                } else {
                    // Si no hay response, mostramos error
                    addMessage('‚ùå Error: ' + (data.message || 'Error desconocido del servidor'), 'bot');
                    showNotification('Error al procesar el mensaje', 'error');
                }
                // =================== FIN DE LA CORRECCI√ìN ===================
                
            } catch (error) {
                hideTyping();
                console.error('Error:', error);
                
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    showNotification(`Error de conexi√≥n. Reintentando... (${retryCount}/${MAX_RETRIES})`, 'warning');
                    setTimeout(() => sendMessage(), RETRY_DELAY * retryCount);
                    return;
                } else {
                    addMessage('üîå Error de conexi√≥n: ' + error.message, 'bot');
                    showNotification('Error de conexi√≥n', 'error');
                    retryCount = 0;
                }
            } finally {
                // Always cleanup - prevent hanging promises
                try {
                    isLoading = false;
                    isProcessingMessage = false;
                    
                    if (messageInput) {
                        messageInput.disabled = false;
                        messageInput.focus();
                    }
                    if (sendButton) {
                        sendButton.disabled = false;
                        sendButton.innerHTML = '<span>Enviar</span><span>üì§</span>';
                    }
                    
                    hideTyping(); // Ensure typing indicator is hidden
                } catch (cleanupError) {
                    console.warn('Cleanup error:', cleanupError);
                }
            }
        }
        
        // Actualizar m√©tricas del cliente
        function updateClientMetrics(responseTime) {
            clientMetrics.messagesCount++;
            clientMetrics.lastMessageTime = Date.now();
            
            // Calcular tiempo de respuesta promedio
            if (clientMetrics.averageResponseTime === 0) {
                clientMetrics.averageResponseTime = responseTime;
            } else {
                clientMetrics.averageResponseTime = 
                    (clientMetrics.averageResponseTime + responseTime) / 2;
            }
        }
        
        // Inicializaci√≥n DOM
        document.addEventListener('DOMContentLoaded', function() {
                // 13. MutationObserver to keep input enabled
                if (messageInput) {
                    const observer = new MutationObserver(() => {
                        if (messageInput.disabled) {
                            messageInput.disabled = false;
                        }
                    });
                    observer.observe(messageInput, { attributes: true, attributeFilter: ['disabled'] });
                }
                
                // El script del modo SOLO se carga al final del documento
                // No es necesario cargarlo din√°micamente aqu√≠
            try {
                // Inicializar elementos DOM
                messagesContainer = document.getElementById('messages');
                messageInput = document.getElementById('messageInput');
                sendButton = document.getElementById('sendButton');
                typingIndicator = document.getElementById('typing');
                charCounter = document.getElementById('charCounter');
                
                
                // Verificar que todos los elementos existen
                if (!messagesContainer || !messageInput || !sendButton || !typingIndicator || !charCounter) {
                    console.error('Error: No se pudieron encontrar todos los elementos DOM necesarios');
                    return;
                }
                
                console.log('‚úÖ Elementos DOM encontrados correctamente');
                
                // 1. Inicializar Chrome Built-in AI
                initializeChromeAI();
                
                // 2. Inicializar cache DOM
                initDOMCache();
                
                // 3. Inicializar estilos CSS
                initializeStyles();
                
                
                setupEventListeners();
                
                // 4. Setup drag & drop for images
                setupDragAndDrop();
                
                // 5. Inicializar contadores y UI
                updateCharCounter();
                
                // 5. Agregar mensaje de bienvenida
                setTimeout(() => {
                    addWelcomeMessage();
                }, 100);
                
                // 6. Focus inicial en el input
                if (messageInput) {
                    messageInput.disabled = false;
                    messageInput.focus();
                }
                
                // Iniciar el loop de forceEnableInput
                forceEnableInput();

                // 12. Periodic check to keep input enabled
                setInterval(() => {
                    if (messageInput && messageInput.disabled) {
                        messageInput.disabled = false;
                    }
                }, 500);
                
                // 7. Inicializar efectos visuales optimizados
                createFloatingParticles();
                setInterval(createParticle, 300);
                
                // 8. Inicializar efectos del fondo de part√≠culas
                initializeParticlesBackground();
                
                // 9. Inicializar Service Worker
                initializeServiceWorker();
                
                // 10. Logs finales
                console.log('‚úÖ Chat inicializado correctamente');
                console.log('üí° Atajos: Ctrl+K (focus input), Ctrl+L (limpiar chat)');
                
                // 11. Notificaci√≥n final (con delay para asegurar que las animaciones est√©n listas)
                setTimeout(() => {
                    showNotification('¬°Chat mejorado listo! üöÄ', 'success');
                }, 200);
                
            } catch (error) {
                console.error('Error durante la inicializaci√≥n:', error);
            }
        });

        
        // Nuevas funciones
        function updateCharCounter() {
            try {
                if (!messageInput || !charCounter) {
                    return;
                }
                
                const currentLength = messageInput.value.length;
                charCounter.textContent = `${currentLength}/1000`;
                
                if (currentLength > 800) {
                    charCounter.style.color = 'var(--warning-color)';
                } else if (currentLength > 950) {
                    charCounter.style.color = 'var(--error-color)';
                } else {
                    charCounter.style.color = 'var(--text-secondary)';
                }
            } catch (error) {
                console.error('Error al actualizar contador de caracteres:', error);
            }
        }
        

        
        function addWelcomeMessage() {
            addMessage('¬°Hola! Soy tu asistente de IA. ¬øEn qu√© puedo ayudarte hoy?', 'bot');
        }
        
        function clearChat() {
            try {
                if (confirm('¬øEst√°s seguro de que quieres limpiar el chat?')) {
                    if (messagesContainer) {
                        messagesContainer.innerHTML = '';
                    }
                    chatHistory = [];
                    addWelcomeMessage();
                    showNotification('Chat limpiado', 'success');
                }
            } catch (error) {
                console.error('Error al limpiar chat:', error);
                showNotification('Error al limpiar el chat', 'error');
            }
        }
        
        // Exportar chat en formato seleccionado
        function exportChat(format) {
            if (chatHistory.length === 0) {
                showNotification('No hay mensajes para exportar', 'warning');
                return;
            }
            const chatText = chatHistory.map(msg => 
                `[${new Date(msg.timestamp).toLocaleString('es-ES')}] ${msg.sender.toUpperCase()}: ${msg.text}`
            ).join('\n\n');

            if (format === 'txt') {
                const blob = new Blob([chatText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat-gemini-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Chat exportado como TXT', 'success');
            } else if (format === 'md') {
                // Markdown: Formato simple
                const mdText = chatHistory.map(msg => 
                    `**${msg.sender.toUpperCase()}** _${new Date(msg.timestamp).toLocaleString('es-ES')}_\n\n${msg.text}`
                ).join('\n\n---\n\n');
                const blob = new Blob([mdText], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat-gemini-${new Date().toISOString().split('T')[0]}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Chat exportado como Markdown', 'success');
            } else if (format === 'pdf') {
                // PDF: Usar jsPDF UMD (window.jspdf.jsPDF)
                if (window.jspdf && window.jspdf.jsPDF) {
                    const jsPDF = window.jspdf.jsPDF;
                    const doc = new jsPDF();
                    let y = 10;
                    chatHistory.forEach(msg => {
                        doc.text(`[${new Date(msg.timestamp).toLocaleString('es-ES')}] ${msg.sender.toUpperCase()}:`, 10, y);
                        y += 7;
                        doc.text(msg.text, 12, y);
                        y += 12;
                    });
                    doc.save(`chat-gemini-${new Date().toISOString().split('T')[0]}.pdf`);
                    showNotification('Chat exportado como PDF', 'success');
                } else {
                    showNotification('jsPDF no est√° disponible. No se puede exportar como PDF.', 'error');
                }
            }
        }
        // Abrir modal de selecci√≥n de formato
        document.getElementById('exportChatBtn').addEventListener('click', function() {
            document.getElementById('exportFormatModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('exportFormatModal').classList.add('show');
            }, 10);
        });

        // Event listeners para botones de formato
        document.querySelectorAll('.export-format-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const format = btn.getAttribute('data-format');
                exportChat(format);
                // Cerrar modal
                document.getElementById('exportFormatModal').classList.remove('show');
                setTimeout(() => {
                    document.getElementById('exportFormatModal').style.display = 'none';
                }, 300);
            });
        });
        
        function toggleVoice() {
            if (!('speechSynthesis' in window)) {
                showNotification('Tu navegador no soporta s√≠ntesis de voz', 'error');
                return;
            }
            
            if (currentUtterance && speechSynthesis.speaking) {
                // Si hay audio reproduci√©ndose
                if (isPaused) {
                    // Reanudar
                    speechSynthesis.resume();
                    isPaused = false;
                    updateVoiceButton('playing');
                    showNotification('Voz reanudada', 'success');
                } else {
                    // Pausar
                    speechSynthesis.pause();
                    isPaused = true;
                    updateVoiceButton('paused');
                    showNotification('Voz pausada', 'info');
                }
            } else {
                // Activar/desactivar voz
                isVoiceEnabled = !isVoiceEnabled;
                
                if (isVoiceEnabled) {
                    updateVoiceButton('enabled');
                    showNotification('S√≠ntesis de voz activada', 'success');
                    
                    // Si hay texto pendiente, reproducirlo
                    if (pendingText) {
                        speakText(pendingText);
                        pendingText = '';
                    }
                } else {
                    updateVoiceButton('disabled');
                    // Detener cualquier voz en reproducci√≥n
                    speechSynthesis.cancel();
                    currentUtterance = null;
                    isPaused = false;
                    showNotification('S√≠ntesis de voz desactivada', 'info');
                }
            }
        }

        function updateVoiceButton(state) {
            const voiceBtn = document.querySelector('.input-actions .action-btn:nth-child(3)');
            if (!voiceBtn) return;
            
            switch(state) {
                case 'playing':
                    voiceBtn.innerHTML = '‚è∏Ô∏è Pausar';
                    voiceBtn.style.background = 'rgba(255, 193, 7, 0.2)';
                    voiceBtn.style.borderColor = 'rgba(255, 193, 7, 0.5)';
                    voiceBtn.style.color = '#ffc107';
                    break;
                case 'paused':
                    voiceBtn.innerHTML = '‚ñ∂Ô∏è Continuar';
                    voiceBtn.style.background = 'rgba(13, 202, 240, 0.2)';
                    voiceBtn.style.borderColor = 'rgba(13, 202, 240, 0.5)';
                    voiceBtn.style.color = '#0dcaf0';
                    break;
                case 'enabled':
                    voiceBtn.innerHTML = 'üîä Voz ON';
                    voiceBtn.style.background = 'rgba(0, 255, 136, 0.2)';
                    voiceBtn.style.borderColor = 'rgba(0, 255, 136, 0.5)';
                    voiceBtn.style.color = 'var(--success-color)';
                    break;
                case 'disabled':
                    voiceBtn.innerHTML = 'üé§ Voz';
                    voiceBtn.style.background = 'rgba(0, 245, 255, 0.1)';
                    voiceBtn.style.borderColor = 'rgba(0, 245, 255, 0.3)';
                    voiceBtn.style.color = 'var(--text-secondary)';
                    break;
            }
        }
        
        function speakText(text) {
            if (!('speechSynthesis' in window)) return;
            
            if (!isVoiceEnabled) {
                // Guardar texto para cuando se active la voz
                pendingText = text;
                return;
            }
            
            // Cancelar cualquier voz anterior
            speechSynthesis.cancel();
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'es-ES';
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;
            
            // Eventos del utterance
            currentUtterance.onstart = function() {
                isPaused = false;
                updateVoiceButton('playing');
            };
            
            currentUtterance.onend = function() {
                currentUtterance = null;
                isPaused = false;
                updateVoiceButton('enabled');
            };
            
            currentUtterance.onerror = function() {
                currentUtterance = null;
                isPaused = false;
                updateVoiceButton('enabled');
                showNotification('Error en la s√≠ntesis de voz', 'error');
            };
            
            speechSynthesis.speak(currentUtterance);
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            
            const colors = {
                success: 'var(--success-color)',
                error: 'var(--error-color)',
                warning: 'var(--warning-color)',
                info: 'var(--primary)'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        
        // Funciones de carga de archivos
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        }
        
        function handleFileUpload(files) {
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                // Validar tama√±o del archivo (m√°ximo 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`El archivo ${file.name} es demasiado grande (m√°ximo 10MB)`, 'error');
                    return;
                }
                
                // Validar tipo de archivo
                const allowedTypes = ['text/plain', 'application/pdf', 'application/msword', 
                                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                    'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                
                if (!allowedTypes.includes(file.type)) {
                    showNotification(`Tipo de archivo no soportado: ${file.name}`, 'error');
                    return;
                }
                
                // Mostrar archivo cargado en el chat
                const fileInfo = `üìé Archivo cargado: ${file.name} (${formatFileSize(file.size)})`;
                addMessage(fileInfo, 'user');
                
                // Procesar archivo seg√∫n su tipo
                if (file.type.startsWith('text/')) {
                    readTextFile(file);
                } else if (file.type.startsWith('image/')) {
                    processImageFile(file);
                } else {
                    // Para PDF y documentos, mostrar informaci√≥n b√°sica
                    addMessage(`üìÑ Documento recibido: ${file.name}. El bot puede ayudarte con preguntas sobre este archivo.`, 'bot');
                }
                
                showNotification(`Archivo ${file.name} cargado exitosamente`, 'success');
            });
        }
        
        function readTextFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                addMessage(`üìù Contenido del archivo:\n${preview}`, 'bot');
            };
            reader.readAsText(file);
        }
        
        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Store image in context for future analysis
                const imageData = {
                    id: Date.now() + Math.random(), // Unique ID
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    dataUrl: e.target.result,
                    uploadedAt: new Date(),
                    analyzed: false
                };
                
                uploadedImages.push(imageData);
                currentImageIndex = uploadedImages.length - 1;
                
                // Create image preview
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '8px';
                img.style.marginTop = '8px';
                img.style.cursor = 'pointer';
                img.title = 'Click to view full size';
                
                // Add click event to view full size
                img.onclick = () => {
                    const fullSizeWindow = window.open('', '_blank');
                    fullSizeWindow.document.write(`
                        <html>
                            <head><title>${file.name}</title></head>
                            <body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#1a1a2e;">
                                <img src="${e.target.result}" style="max-width:100%;max-height:100%;object-fit:contain;">
                            </body>
                        </html>
                    `);
                };
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = customization.currentAvatar || 'ü§ñ';
                
                const contentWrapper = document.createElement('div');
                const content = document.createElement('div');
                content.className = 'message-content';
                
                // Enhanced message with context info
                content.innerHTML = `
                    üñºÔ∏è <strong>${t('imageUploaded')}:</strong> ${file.name}<br>
                    üìä <em>Tama√±o:</em> ${formatFileSize(file.size)}<br>
                    üéØ <strong>Ahora puedes:</strong><br>
                    ‚Ä¢ Escribir "analiza la imagen" o "describe la imagen"<br>
                    ‚Ä¢ Escribir "¬øqu√© ves en la imagen?"<br>
                    ‚Ä¢ Hacer preguntas espec√≠ficas sobre el contenido<br>
                    <small style="color: #00d4ff;">üí° Esta imagen queda en el contexto de la conversaci√≥n</small>
                `;
                content.appendChild(img);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                contentWrapper.appendChild(content);
                contentWrapper.appendChild(timeDiv);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentWrapper);
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Show quick action buttons
                addImageAnalysisButtons(imageData.id);
            };
            reader.readAsDataURL(file);
        }
        
        // Add quick analysis buttons for uploaded images
        function addImageAnalysisButtons(imageId) {
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'image-analysis-buttons';
            buttonsContainer.style.cssText = `
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 12px;
                padding: 12px;
                background: rgba(0, 212, 255, 0.1);
                border-radius: 8px;
                border-left: 3px solid var(--accent-color);
            `;
            
            const buttons = [
                { text: t('analyzeButton'), action: t('analyzePrompt') },
                { text: t('describeButton'), action: t('describePrompt') },
                { text: t('colorsButton'), action: t('colorsPrompt') },
                { text: t('textButton'), action: t('textPrompt') },
                { text: t('interpretButton'), action: t('interpretPrompt') }
            ];
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                button.style.cssText = `
                    background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
                    border: none;
                    border-radius: 6px;
                    color: white;
                    padding: 6px 12px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    flex: 1;
                    min-width: 80px;
                `;
                
                button.onmouseover = () => {
                    button.style.transform = 'translateY(-2px)';
                    button.style.boxShadow = '0 4px 12px rgba(0, 212, 255, 0.4)';
                };
                
                button.onmouseout = () => {
                    button.style.transform = 'translateY(0)';
                    button.style.boxShadow = 'none';
                };
                
                button.onclick = () => {
                    // Auto-send the analysis request
                    messageInput.value = btn.action;
                    sendMessage();
                };
                
                buttonsContainer.appendChild(button);
            });
            
            messagesContainer.appendChild(buttonsContainer);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Enhanced message detection for image analysis
        function hasImageAnalysisRequest(message) {
            const imageKeywords = [
                'analiza', 'describe', 'imagen', 'foto', 'picture', 'analyze', 'describe',
                '¬øqu√© ves', 'what do you see', 'explica', 'explain', 'interpreta', 'interpret',
                'colores', 'colors', 'texto', 'text', 'lee', 'read', 'contenido', 'content'
            ];
            
            return imageKeywords.some(keyword => 
                message.toLowerCase().includes(keyword.toLowerCase())
            );
        }
        
        // Get current image context for AI processing
        function getCurrentImageContext() {
            if (uploadedImages.length === 0) return null;
            
            const currentImage = uploadedImages[currentImageIndex];
            return {
                hasImage: true,
                imageName: currentImage.name,
                imageData: currentImage.dataUrl,
                imageId: currentImage.id,
                uploadedAt: currentImage.uploadedAt
            };
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Funci√≥n para configurar event listeners
        function setupEventListeners() {
            try {
                // Event Listeners para input
                if (messageInput) {
                    messageInput.addEventListener('input', function() {
                        updateCharCounter();
                        autoResizeTextarea(messageInput);
                    });
                    
                    messageInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                    
                    // Inicializar altura del textarea
                    autoResizeTextarea(messageInput);
                    
                    // Focus inicial
                    messageInput.focus();
                }
                

                
                // Event listener para el bot√≥n de enviar
                if (sendButton) {
                    sendButton.addEventListener('click', sendMessage);
                }
                
                // Event listener para carga de archivos
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        handleFileUpload(e.target.files);
                        // Limpiar el input para permitir cargar el mismo archivo nuevamente
                        e.target.value = '';
                    });
                }
                
                // Setup drag and drop functionality
                setupDragAndDrop();
                
                // Event listeners para botones de acci√≥n
                const actionButtons = document.querySelectorAll('.action-btn');
                if (actionButtons.length >= 4) {
                    // Bot√≥n limpiar chat (primer bot√≥n)
                    actionButtons[0].addEventListener('click', clearChat);
                    
                    // Bot√≥n exportar (segundo bot√≥n)
                    actionButtons[1].addEventListener('click', exportChat);
                    
                    // Bot√≥n voz (tercer bot√≥n)
                    actionButtons[2].addEventListener('click', toggleVoice);
                    
                    // Bot√≥n archivo (cuarto bot√≥n)
                    actionButtons[3].addEventListener('click', uploadFile);
                }
                
                // Configurar drag and drop
                setupDragAndDrop();
                
                // Configurar atajos de teclado
                setupKeyboardShortcuts();
                
                // Configurar botones de idioma
                setupLanguageButtons();
                
                console.log('‚úÖ Event listeners configurados correctamente');
            } catch (error) {
                console.error('Error al configurar event listeners:', error);
            }
        }
        
        // Funci√≥n para configurar drag and drop
        function setupDragAndDrop() {
            if (!messagesContainer) return;
            
            messagesContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                messagesContainer.style.backgroundColor = 'rgba(0, 245, 255, 0.1)';
            });
            
            messagesContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                messagesContainer.style.backgroundColor = '';
            });
            
            messagesContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                messagesContainer.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files);
                }
            });
        }
        
        // Funci√≥n para configurar atajos de teclado
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    if (messageInput) messageInput.focus();
                }
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    clearChat();
                }
            });
        }
        
        // Los event listeners ahora se configuran en setupEventListeners()
        
        // === FUNCIONES DE ANIMACI√ìN OPTIMIZADAS ===
        function createFloatingParticles() {
            if (!PERFORMANCE_CONFIG.enableParticles) return;
            
            const container = getElement('particleContainer');
            if (!container) return;

            // Pool de part√≠culas reutilizables
            const particlePool = [];
            
            function getParticleFromPool() {
                if (particlePool.length > 0) {
                    return particlePool.pop();
                }
                
                const particle = document.createElement('div');
                particle.className = 'particle';
                return particle;
            }
            
            function returnParticleToPool(particle) {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
                particle.style.animation = '';
                particlePool.push(particle);
            }

            function createParticle() {
                if (particles.length >= MAX_PARTICLES) return;
                
                // Verificar si el usuario est√° inactivo para reducir animaciones
                if (document.hidden) return;

                const particle = getParticleFromPool();
                
                // Posici√≥n inicial optimizada
                const startX = Math.random() * window.innerWidth;
                const startY = window.innerHeight + 10;
                
                particle.style.left = startX + 'px';
                particle.style.top = startY + 'px';
                
                // Propiedades de animaci√≥n optimizadas
                const duration = 6000 + Math.random() * 3000; // Reducido
                const drift = (Math.random() - 0.5) * 80; // Reducido
                
                particle.style.animation = `float ${duration}ms linear`;
                particle.style.setProperty('--drift', drift + 'px');
                
                container.appendChild(particle);
                particles.push(particle);
                
                // Usar setTimeout optimizado
                setTimeout(() => {
                    const index = particles.indexOf(particle);
                    if (index > -1) {
                        particles.splice(index, 1);
                        returnParticleToPool(particle);
                    }
                }, duration);
            }

            function animate() {
                const now = performance.now();
                if (now - lastParticleTime > PARTICLE_INTERVAL) {
                    createParticle();
                    lastParticleTime = now;
                }
                
                // Solo continuar animaci√≥n si la p√°gina est√° visible
                if (!document.hidden) {
                    animationId = requestAnimationFrame(animate);
                } else {
                    // Reanudar cuando la p√°gina vuelva a ser visible
                    document.addEventListener('visibilitychange', function resumeAnimation() {
                        if (!document.hidden) {
                            document.removeEventListener('visibilitychange', resumeAnimation);
                            animate();
                        }
                    });
                }
            }

            animate();
        }
        
        // Create floating particles (funci√≥n simplificada para compatibilidad)
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + 'vw';
            particle.style.animationDelay = Math.random() * 6 + 's';
            particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
            document.body.appendChild(particle);
            
            setTimeout(() => {
                particle.remove();
            }, 6000);
        }
        
        // Funci√≥n para inicializar animaciones CSS
        function initializeStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
                
                /* Estilos para drag and drop */
                .chat-messages.drag-over {
                    background: rgba(0, 245, 255, 0.1) !important;
                    border: 2px dashed var(--primary) !important;
                    border-radius: 12px;
                }
                
                /* Estilos para el bot√≥n de archivo */
                .action-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
                }
                
                /* Estilos para im√°genes en mensajes */
                .message-content img {
                    transition: transform 0.3s ease;
                    cursor: pointer;
                }
                
                .message-content img:hover {
                    transform: scale(1.05);
                }
            `;
            document.head.appendChild(style);
        }
        
        // Funci√≥n para inicializar Service Worker con soporte HTTPS
        function initializeServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Verificar si estamos en un contexto seguro (HTTPS)
                const isSecureContext = window.isSecureContext || window.location.protocol === 'https:';
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                if (isSecureContext || isLocalhost) {
                    navigator.serviceWorker.register('/sw.js')
                        .then(function(registration) {
                            console.log('‚úÖ Service Worker registrado:', registration.scope);
                            
                            // Escuchar mensajes del Service Worker
                            navigator.serviceWorker.addEventListener('message', function(event) {
                                if (event.data.type === 'SW_ACTIVATED') {
                                    console.log('üîÑ Service Worker activado con HTTPS:', event.data.version);
                                    if (event.data.features && event.data.features.caching) {
                                        showNotification('PWA optimizada con HTTPS activada', 'success');
                                    }
                                }
                                
                                if (event.data.type === 'PERFORMANCE_UPDATE') {
                                    console.log('üìä M√©tricas de rendimiento:', event.data.metrics);
                                }
                            });
                            
                            // Verificar actualizaciones del Service Worker
                            registration.addEventListener('updatefound', function() {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', function() {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showNotification('Nueva versi√≥n disponible. Recarga para actualizar.', 'info');
                                    }
                                });
                            });
                        })
                        .catch(function(error) {
                            console.log('‚ùå Error registrando Service Worker:', error);
                            if (!isSecureContext && !isLocalhost) {
                                showNotification('PWA requiere HTTPS para funcionalidad completa', 'warning');
                            }
                        });
                } else {
                    console.warn('‚ö†Ô∏è Service Worker requiere contexto seguro (HTTPS)');
                    showNotification('Para funcionalidad PWA completa, usa HTTPS', 'info');
                }
            } else {
                console.warn('‚ö†Ô∏è Service Worker no soportado en este navegador');
            }
        }
        
        // Funci√≥n para limpiar cache del navegador
        function clearBrowserCache() {
            try {
                // Limpiar localStorage
                if (typeof(Storage) !== "undefined") {
                    localStorage.clear();
                }
                
                // Limpiar sessionStorage
                if (typeof(Storage) !== "undefined") {
                    sessionStorage.clear();
                }
                
                // Forzar recarga sin cache
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        for (let name of names) {
                            caches.delete(name);
                        }
                    });
                }
                
                console.log('‚úÖ Cache del navegador limpiado');
            } catch (error) {
                console.error('Error al limpiar cache:', error);
            }
        }
        
        // Funci√≥n para validar sintaxis JavaScript
        function validateJavaScriptSyntax() {
            try {
                // Verificar que todas las funciones est√©n correctamente definidas
                const requiredFunctions = [
                    'addMessage', 'showTyping', 'hideTyping',
                    'sendMessage', 'updateCharCounter', 'clearChat',
                    'exportChat', 'toggleVoice', 'uploadFile', 'setupEventListeners'
                ];
                
                requiredFunctions.forEach(funcName => {
                    if (typeof window[funcName] !== 'function') {
                        console.error(`‚ùå Funci√≥n ${funcName} no est√° definida`);
                    } else {
                        console.log(`‚úÖ Funci√≥n ${funcName} correctamente definida`);
                    }
                });
                
                console.log('‚úÖ Validaci√≥n de sintaxis JavaScript completada');
                return true;
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de sintaxis:', error);
                return false;
            }
        }
        
        // Inicializar fondo de part√≠culas
        function initializeParticlesBackground() {
            // Variables para el canvas de red neuronal
            const canvas = document.getElementById('neural-canvas');
            const ctx = canvas.getContext('2d');
            let neuralParticles = [];
            let neuralAnimationId;

            // Configuraci√≥n de part√≠culas
            const config = {
                particleCount: 100,
                maxDistance: 120,
                particleSpeed: 0.5,
                nodeRadius: 2,
                connectionOpacity: 0.3,
                particleOpacity: 0.7
            };

            // Clase Particle
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.vx = (Math.random() - 0.5) * config.particleSpeed;
                    this.vy = (Math.random() - 0.5) * config.particleSpeed;
                    this.radius = config.nodeRadius + Math.random() * 2;
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;

                    // Rebote en los bordes
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;

                    // Mantener dentro de los l√≠mites
                    this.x = Math.max(0, Math.min(canvas.width, this.x));
                    this.y = Math.max(0, Math.min(canvas.height, this.y));
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0, 212, 255, ${config.particleOpacity})`;
                    ctx.fill();

                    // Efecto de brillo
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius * 0.5, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                }
            }

            // Inicializar canvas
            function initCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            // Crear part√≠culas
            function createParticles() {
                neuralParticles = [];
                for (let i = 0; i < config.particleCount; i++) {
                    neuralParticles.push(new Particle());
                }
            }

            // Dibujar conexiones entre part√≠culas
            function drawConnections() {
                for (let i = 0; i < neuralParticles.length; i++) {
                    for (let j = i + 1; j < neuralParticles.length; j++) {
                        const dx = neuralParticles[i].x - neuralParticles[j].x;
                        const dy = neuralParticles[i].y - neuralParticles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < config.maxDistance) {
                            const opacity = (1 - distance / config.maxDistance) * config.connectionOpacity;
                            ctx.beginPath();
                            ctx.moveTo(neuralParticles[i].x, neuralParticles[i].y);
                            ctx.lineTo(neuralParticles[j].x, neuralParticles[j].y);
                            ctx.strokeStyle = `rgba(0, 212, 255, ${opacity})`;
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                    }
                }
            }

            // Loop de animaci√≥n
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Actualizar y dibujar part√≠culas
                neuralParticles.forEach(particle => {
                    particle.update();
                    particle.draw();
                });

                // Dibujar conexiones
                drawConnections();

                neuralAnimationId = requestAnimationFrame(animate);
            }

            // Redimensionar canvas
            function resizeCanvas() {
                initCanvas();
                createParticles();
            }

            // Event listeners para el canvas
            window.addEventListener('resize', resizeCanvas);

            // Inicializar red neuronal
            initCanvas();
            createParticles();
            animate();

            // Efecto de interacci√≥n con el mouse en las part√≠culas
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                neuralParticles.forEach(particle => {
                    const dx = mouseX - particle.x;
                    const dy = mouseY - particle.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 100) {
                        const force = (100 - distance) / 100;
                        particle.vx += dx * force * 0.001;
                        particle.vy += dy * force * 0.001;
                    }
                });
            });
        }
        
        // Limpiar cache al cargar la p√°gina
        window.addEventListener('load', function() {
            clearBrowserCache();
            validateJavaScriptSyntax();
            initializeParticlesBackground();
        });
        
        // Forzar recarga sin cache si hay errores
        window.addEventListener('error', function(e) {
            if (e.message.includes('SyntaxError') || e.message.includes('Unexpected token')) {
                console.warn('üîÑ Error de sintaxis detectado, forzando recarga sin cache...');
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            }
        });

        // Funci√≥n para actualizar textos de botones de an√°lisis cuando cambia el idioma
        function updateImageAnalysisButtons() {
            // Update image analysis buttons
            const analysisButtons = document.querySelectorAll('.image-analysis-buttons button');
            if (analysisButtons.length > 0) {
                const buttonTexts = [
                    t('analyzeButton'),
                    t('describeButton'),
                    t('colorsButton'),
                    t('textButton'),
                    t('interpretButton')
                ];
                
                const buttonActions = [
                    t('analyzePrompt'),
                    t('describePrompt'),
                    t('colorsPrompt'),
                    t('textPrompt'),
                    t('interpretPrompt')
                ];
                
                analysisButtons.forEach((button, index) => {
                    if (index < buttonTexts.length) {
                        button.textContent = buttonTexts[index];
                        // Actualizar tambi√©n el action del onclick
                        button.onclick = function() {
                            const messageInput = document.getElementById('messageInput');
                            if (messageInput) {
                                messageInput.value = buttonActions[index];
                                sendMessage();
                            }
                        };
                    }
                });
            }
            
            // Update AI mode display
            updateAIModeDisplay();
        }
        
        // Function to update AI mode dropdown texts when language changes
        function updateAIModeDropdownTexts() {
            const menuItems = document.querySelectorAll('.ai-mode-menu-item');
            
            const options = [
                {
                    mode: 'hybrid',
                    label: t('aiModeHybrid'),
                    description: getCurrentLanguage() === 'es' ? 'Selecci√≥n inteligente autom√°tica' : 'Smart automatic selection'
                },
                {
                    mode: 'server',
                    label: t('aiModeServer'),
                    description: getCurrentLanguage() === 'es' ? 'Gemini avanzado en la nube' : 'Advanced Gemini in the cloud'
                },
                {
                    mode: 'chrome',
                    label: t('aiModeChrome'),
                    description: getCurrentLanguage() === 'es' ? 'Procesamiento local privado' : 'Private local processing'
                }
            ];
            
            menuItems.forEach((item, index) => {
                if (index < options.length) {
                    const option = options[index];
                    item.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 2px;">${option.label}</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7);">${option.description}</div>
                    `;
                }
            });
            
            // Update main button text and labels
            updateAIModeDisplay();
        }

        // Internacionalizaci√≥n b√°sica con botones
        function setupLanguageButtons() {
            const langButtons = document.querySelectorAll('.lang-btn');
            
            langButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    document.documentElement.lang = lang;
                    
                    // Resaltar el bot√≥n del idioma seleccionado
                    langButtons.forEach(btn => {
                        btn.style.background = 'rgba(0, 245, 255, 0.1)';
                        btn.style.borderColor = 'rgba(0, 245, 255, 0.3)';
                        btn.style.color = 'var(--text-secondary)';
                    });
                    
                    this.style.background = 'rgba(0, 255, 136, 0.2)';
                    this.style.borderColor = 'rgba(0, 255, 136, 0.5)';
                    this.style.color = 'var(--success-color)';
                    
                    // Actualizar textos de botones de an√°lisis de imagen existentes
                    updateImageAnalysisButtons();
                    
                    // Actualizar textos del dropdown de AI mode
                    updateAIModeDropdownTexts();
                    
                    showNotification(`Idioma cambiado a ${lang === 'es' ? 'Espa√±ol' : 'English'}`, 'success');
                });
            });
            
            // Resaltar el bot√≥n del idioma actual al cargar
            const currentLang = document.documentElement.lang || 'es';
            const currentLangButton = document.querySelector(`.lang-btn[data-lang="${currentLang}"]`);
            if (currentLangButton) {
                currentLangButton.style.background = 'rgba(0, 255, 136, 0.2)';
                currentLangButton.style.borderColor = 'rgba(0, 255, 136, 0.5)';
                currentLangButton.style.color = 'var(--success-color)';
            }
        }
        
        // Script de pruebas desactivado
        // El bucle autom√°tico de pruebas ha sido eliminado para evitar ejecuciones no deseadas
        console.log('‚ÑπÔ∏è Modo de pruebas autom√°ticas desactivado');
        // Para ejecutar pruebas, usar los comandos espec√≠ficos desde la terminal
    </script>
    
    <!-- Sistema de Personalizaci√≥n -->
    <script>
        // Configuraci√≥n de personalizaci√≥n
        const customization = {
            currentTheme: localStorage.getItem('chatTheme') || 'default',
            currentFontSize: localStorage.getItem('chatFontSize') || 'medium',
            currentAvatar: localStorage.getItem('chatAvatar') || 'ü§ñ'
        };

        // Temas disponibles
        const themes = {
            default: {
                '--bg-color': '#1a1a2e',
                '--text-color': '#ffffff',
                '--accent-color': '#667eea',
                '--border-color': '#333366',
                '--hover-bg': '#2a2a3e',
                '--accent-color-rgb': '102, 126, 234'
            },
            cyberpunk: {
                '--bg-color': '#0a0a0a',
                '--text-color': '#ff006e',
                '--accent-color': '#00f5ff',
                '--border-color': '#ff006e',
                '--hover-bg': '#1a0a1a',
                '--accent-color-rgb': '0, 245, 255'
            },
            'neon-green': {
                '--bg-color': '#001100',
                '--text-color': '#39ff14',
                '--accent-color': '#00ff88',
                '--border-color': '#39ff14',
                '--hover-bg': '#002200',
                '--accent-color-rgb': '0, 255, 136'
            },
            sunset: {
                '--bg-color': '#2d1b0e',
                '--text-color': '#ffffff',
                '--accent-color': '#ff6b35',
                '--border-color': '#f7931e',
                '--hover-bg': '#3d2b1e',
                '--accent-color-rgb': '255, 107, 53'
            },
            'purple-rain': {
                '--bg-color': '#1a1a2e',
                '--text-color': '#ffffff',
                '--accent-color': '#667eea',
                '--border-color': '#764ba2',
                '--hover-bg': '#2a2a3e',
                '--accent-color-rgb': '102, 126, 234'
            }
        };

        // Aplicar tema
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (theme) {
                console.log(`üé® Aplicando tema: ${themeName}`);
                Object.entries(theme).forEach(([property, value]) => {
                    console.log(`   ${property}: ${value}`);
                    document.documentElement.style.setProperty(property, value);
                });
                customization.currentTheme = themeName;
                localStorage.setItem('chatTheme', themeName);
                updateActiveButtons();
                console.log('‚úÖ Tema aplicado correctamente');
            } else {
                console.error(`‚ùå Tema no encontrado: ${themeName}`);
            }
        }

        // Aplicar tama√±o de fuente
        function applyFontSize(size) {
            const sizes = {
                small: '0.85rem',
                medium: '1rem',
                large: '1.15rem'
            };
            const fontSize = sizes[size];
            if (fontSize) {
                console.log(`üìù Aplicando tama√±o de fuente: ${size} (${fontSize})`);
                document.documentElement.style.setProperty('--base-font-size', fontSize);
                customization.currentFontSize = size;
                localStorage.setItem('chatFontSize', size);
                updateActiveButtons();
                console.log('‚úÖ Tama√±o de fuente aplicado correctamente');
            } else {
                console.error(`‚ùå Tama√±o de fuente no encontrado: ${size}`);
            }
        }

        // Aplicar avatar
        function applyAvatar(avatar) {
            console.log(`ü§ñ Aplicando avatar: ${avatar}`);
            customization.currentAvatar = avatar;
            localStorage.setItem('chatAvatar', avatar);
            
            // Actualizar todos los avatares del bot en la interfaz existente
            const existingAvatars = document.querySelectorAll('.message.bot .message-avatar');
            console.log(`   Encontrados ${existingAvatars.length} avatares existentes`);
            existingAvatars.forEach(el => {
                el.textContent = avatar;
            });
            
            // Tambi√©n actualizar la variable CSS para futuros mensajes
            document.documentElement.style.setProperty('--current-bot-avatar', `'${avatar}'`);
            
            updateActiveButtons();
            console.log('‚úÖ Avatar aplicado correctamente');
        }

        // Actualizar botones activos
        function updateActiveButtons() {
            // Temas
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === customization.currentTheme);
            });
            // Fuentes
            document.querySelectorAll('.font-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size === customization.currentFontSize);
            });
            // Avatares
            document.querySelectorAll('.avatar-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.avatar === customization.currentAvatar);
            });
        }

        // Funciones de animaci√≥n del modal
        function openModal() {
            const modal = document.getElementById('customizeModal');
            modal.style.display = 'flex';
            
            // Forzar reflow para que la animaci√≥n funcione
            modal.offsetHeight;
            
            // A√±adir clase show para activar animaciones
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }

        function closeModal() {
            const modal = document.getElementById('customizeModal');
            modal.classList.remove('show');
            
            // Esperar a que termine la animaci√≥n antes de ocultar
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Funci√≥n para aplicar tema con animaci√≥n
        function applyThemeWithAnimation(themeName) {
            const body = document.body;
            body.classList.add('theme-changing');
            
            // Aplicar el tema despu√©s de un peque√±o delay para mostrar el loading
            setTimeout(() => {
                applyTheme(themeName);
                
                // Remover el indicador de carga despu√©s de que termine la transici√≥n
                setTimeout(() => {
                    body.classList.remove('theme-changing');
                }, 400);
            }, 100);
        }

        // Funci√≥n para feedback visual en botones
        function addButtonFeedback(button, callback) {
            button.addEventListener('click', (e) => {
                // Crear efecto ripple
                const rect = button.getBoundingClientRect();
                const ripple = document.createElement('span');
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    transform: scale(0);
                    animation: ripple-effect 0.6s ease-out;
                    pointer-events: none;
                `;
                
                button.style.position = 'relative';
                button.style.overflow = 'hidden';
                button.appendChild(ripple);
                
                // Ejecutar callback despu√©s del feedback visual
                setTimeout(() => {
                    if (callback) callback();
                    setTimeout(() => ripple.remove(), 600);
                }, 150);
            });
        }

        // Inicializar personalizaci√≥n
        function initCustomization() {
            // Aplicar configuraci√≥n guardada
            applyTheme(customization.currentTheme);
            applyFontSize(customization.currentFontSize);
            applyAvatar(customization.currentAvatar);

            // Event listeners con animaciones suaves
            document.querySelector('.customize-btn').addEventListener('click', () => {
                openModal();
                updateActiveButtons();
            });

            document.querySelector('.close-modal').addEventListener('click', () => {
                closeModal();
            });

            // Cerrar modal al hacer click fuera
            document.getElementById('customizeModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('customizeModal')) {
                    closeModal();
                }
            });

            // Event listeners para temas con animaci√≥n
            document.querySelectorAll('.theme-btn').forEach(btn => {
                addButtonFeedback(btn, () => {
                    applyThemeWithAnimation(btn.dataset.theme);
                });
            });

            // Event listeners para fuentes con animaci√≥n
            document.querySelectorAll('.font-btn').forEach(btn => {
                addButtonFeedback(btn, () => {
                    applyFontSize(btn.dataset.size);
                });
            });

            // Event listeners para avatares con animaci√≥n
            document.querySelectorAll('.avatar-btn').forEach(btn => {
                addButtonFeedback(btn, () => {
                    applyAvatar(btn.dataset.avatar);
                });
            });
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', initCustomization);
    </script>

    <!-- Sistema de Chrome AI Extendido -->
    <script>
        // Variables globales para Chrome AI Extendido
        let chromeAIExtended = null;
        let aiCapabilities = {};

        // Inicializar Chrome AI al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            // Mostrar botones por defecto
            updateAIButtonsVisibility();
            
            // Configurar event listeners de inmediato
            setupAIEventListeners();
            
            // Intentar inicializar Chrome AI Manager
            await initializeChromeAIExtended();
        });

        // Funci√≥n para inicializar Chrome AI de forma as√≠ncrona
        async function initializeChromeAIExtended() {
            try {
                // Esperar a que ChromeAIManager est√© disponible
                let attempts = 0;
                const maxAttempts = 50; // 5 segundos m√°ximo
                
                while (!window.ChromeAIManager && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (window.ChromeAIManager) {
                    chromeAIExtended = new ChromeAIManager();
                    const initialized = await chromeAIExtended.initialize();
                    aiCapabilities = chromeAIExtended.capabilities || {};
                    
                    console.log('üß† Chrome AI Capabilities:', aiCapabilities);
                    
                    // Actualizar visibilidad con las capacidades reales
                    updateAIButtonsVisibility();
                } else {
                    console.log('‚ö†Ô∏è ChromeAIManager no disponible, manteniendo botones visibles como fallback');
                    // Mantener botones visibles como fallback
                    aiCapabilities = {
                        writer: true,
                        proofreader: true,
                        translator: true
                    };
                }
            } catch (error) {
                console.error('Error inicializando Chrome AI:', error);
                // En caso de error, mantener botones visibles
                aiCapabilities = {
                    writer: true,
                    proofreader: true,
                    translator: true
                };
            }
        }

        // Actualizar indicador de estado del sistema h√≠brido
        function updateAIStatusIndicator() {
            const statusIndicator = document.getElementById('ai-status-indicator');
            const statusText = document.getElementById('ai-status-text');
            const chromeAIStatus = document.getElementById('chrome-ai-status');
            const geminiStatus = document.getElementById('gemini-status');
            const performanceStats = document.getElementById('performance-stats');

            if (!statusIndicator) return;

            const capabilities = chromeAI.getCapabilities();
            const hasAnyChrome = Object.values(capabilities).some(cap => cap);
            const hasPrompt = capabilities.prompt || false;
            const availableAPIs = Object.keys(capabilities).filter(api => capabilities[api]);
            
            if (hasAnyChrome) {
                if (hasPrompt && availableAPIs.length === 1) {
                    // Solo Prompt API disponible - Optimizado para velocidad
                    statusIndicator.style.background = 'linear-gradient(135deg, rgba(0, 200, 255, 0.1), rgba(100, 150, 255, 0.1))';
                    statusIndicator.style.border = '1px solid rgba(0, 200, 255, 0.3)';
                    statusText.textContent = '‚ö° Chrome AI Ultra-R√°pido (Prompt + Cache)';
                    chromeAIStatus.textContent = '‚ö° Optimizado';
                } else {
                    // M√∫ltiples APIs disponibles
                    statusIndicator.style.background = 'linear-gradient(135deg, rgba(0, 255, 0, 0.1), rgba(0, 200, 255, 0.1))';
                    statusIndicator.style.border = '1px solid rgba(0, 255, 100, 0.3)';
                    statusText.textContent = 'üü¢ Sistema H√≠brido Completo';
                    chromeAIStatus.textContent = '‚úÖ M√∫ltiples APIs';
                }
            } else {
                statusIndicator.style.background = 'linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 100, 0, 0.1))';
                statusIndicator.style.border = '1px solid rgba(255, 165, 0, 0.3)';
                statusText.textContent = 'üü° Solo Gemini API (Optimizado)';
                chromeAIStatus.textContent = '‚ùå No disponible';
            }

            // Mostrar estad√≠sticas de rendimiento en tiempo real
            if (chromeAI && performanceStats) {
                updatePerformanceDisplay();
            }

            // Agregar informaci√≥n adicional para Prompt API
            if (hasPrompt && availableAPIs.length === 1) {
                const additionalInfo = document.createElement('div');
                additionalInfo.style.fontSize = '0.75rem';
                additionalInfo.style.color = 'var(--text-secondary)';
                additionalInfo.style.marginTop = '5px';
                additionalInfo.textContent = 'ÔøΩ Ultra-optimizado: Cache + Sesiones pre-inicializadas + Prompts cortos';
                
                // Limpiar informaci√≥n adicional previa
                const existing = statusIndicator.querySelector('.additional-info');
                if (existing) existing.remove();
                
                additionalInfo.className = 'additional-info';
                statusIndicator.appendChild(additionalInfo);
            }
        }

        // Actualizar estad√≠sticas de rendimiento en tiempo real
        function updatePerformanceDisplay() {
            const performanceStats = document.getElementById('performance-stats');
            if (!performanceStats || !chromeAI) return;

            try {
                const stats = chromeAI.getPerformanceStats();
                let statsText = '';
                
                if (stats['chrome-ai']) {
                    statsText += `Chrome AI: ${stats['chrome-ai'].averageMs}ms`;
                }
                
                if (stats['gemini'] || stats['gemini-fallback']) {
                    const geminiStats = stats['gemini'] || stats['gemini-fallback'];
                    if (statsText) statsText += ' | ';
                    statsText += `Gemini: ${geminiStats.averageMs}ms`;
                }
                
                if (statsText) {
                    performanceStats.textContent = statsText;
                } else {
                    performanceStats.textContent = 'Esperando m√©tricas...';
                }
            } catch (error) {
                performanceStats.textContent = 'Error en m√©tricas';
            }
        }

        // Actualizar estad√≠sticas cada 3 segundos
        setInterval(updatePerformanceDisplay, 3000);

        // Configurar event listeners para modales de IA
        function setupAIEventListeners() {
            // Botones para abrir modales (ahora desde el modal de personalizaci√≥n)
            const writerBtn = document.querySelector('.ai-writer-btn');
            const correctorBtn = document.querySelector('.ai-corrector-btn');
            const translatorBtn = document.querySelector('.ai-translator-btn');
            const summarizerBtn = document.querySelector('.ai-summarizer-btn');
            const rewriterBtn = document.querySelector('.ai-rewriter-btn');
            const proofreaderBtn = document.querySelector('.ai-proofreader-btn');
            
            // Event listeners para abrir modales AI
            writerBtn?.addEventListener('click', () => {
                closeModal(); // Cerrar modal de personalizaci√≥n primero
                setTimeout(() => openAIModal('writerModal'), 300); // Peque√±o delay para la transici√≥n
            });
            correctorBtn?.addEventListener('click', () => {
                closeModal();
                setTimeout(() => openAIModal('correctorModal'), 300);
            });
            translatorBtn?.addEventListener('click', () => {
                closeModal();
                setTimeout(() => openAIModal('translatorModal'), 300);
            });
            summarizerBtn?.addEventListener('click', () => {
                closeModal();
                setTimeout(() => openAIModal('summarizerModal'), 300);
            });
            rewriterBtn?.addEventListener('click', () => {
                closeModal();
                setTimeout(() => openAIModal('rewriterModal'), 300);
            });
            proofreaderBtn?.addEventListener('click', () => {
                closeModal();
                setTimeout(() => openAIModal('proofreaderModal'), 300);
            });

            // Botones para cerrar modales
            document.querySelectorAll('.close-ai-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalId = e.target.getAttribute('data-modal');
                    closeAIModal(modalId);
                });
            });

            // Cerrar modal al hacer click fuera
            document.querySelectorAll('.ai-modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeAIModal(modal.id);
                    }
                });
            });
        }

        // Abrir modal de IA con animaci√≥n
        function openAIModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                requestAnimationFrame(() => {
                    modal.classList.add('show');
                });
            }
        }

        // Cerrar modal de IA con animaci√≥n
        function closeAIModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        }

        // Actualizar visibilidad de botones seg√∫n capacidades
        function updateAIButtonsVisibility() {
            const capabilities = chromeAI ? chromeAI.getCapabilities() : {};
            const hasPrompt = capabilities.prompt || false;
            
            const buttons = [
                { btn: document.querySelector('.ai-writer-btn'), api: 'writer' },
                { btn: document.querySelector('.ai-corrector-btn'), api: 'proofreader' },
                { btn: document.querySelector('.ai-translator-btn'), api: 'translator' },
                { btn: document.querySelector('.ai-summarizer-btn'), api: 'summarizer' },
                { btn: document.querySelector('.ai-rewriter-btn'), api: 'rewriter' }
            ];

            buttons.forEach(({ btn, api }) => {
                if (!btn) return;
                
                // Mostrar todos los botones (siempre hay fallback)
                btn.style.display = 'flex';
                
                // Actualizar clases seg√∫n disponibilidad
                btn.classList.remove('chrome-ai-full', 'chrome-ai-prompt', 'gemini-fallback');
                
                if (capabilities[api]) {
                    // API espec√≠fica disponible
                    btn.classList.add('chrome-ai-full');
                    btn.title = `${btn.getAttribute('aria-label')} - Chrome AI nativo`;
                } else if (hasPrompt) {
                    // Solo Prompt API disponible
                    btn.classList.add('chrome-ai-prompt');
                    btn.title = `${btn.getAttribute('aria-label')} - Chrome AI Prompt + Gemini`;
                } else {
                    // Solo Gemini disponible
                    btn.classList.add('gemini-fallback');
                    btn.title = `${btn.getAttribute('aria-label')} - Gemini API`;
                }
            });
        }

        // === ESCRITOR AI ===
        async function generateText() {
            const prompt = document.getElementById('writerPrompt').value.trim();
            const tone = document.getElementById('writerTone').value;
            const length = document.getElementById('writerLength').value;
            const outputDiv = document.getElementById('writerOutput');
            const resultDiv = document.getElementById('writerResult');

            if (!prompt) {
                alert('Por favor, describe lo que quieres escribir.');
                return;
            }

            try {
                const startTime = performance.now();
                
                // Mostrar loading
                outputDiv.innerHTML = '<div class="ai-loading">‚ö° Generando texto...</div>';
                resultDiv.style.display = 'block';

                // Crear prompt para escritor AI
                const fullPrompt = `Escribe un texto con tono ${tone} y longitud ${length} sobre: ${prompt}`;

                let result;

                // Usar Chrome AI si est√° disponible
                if (chromeAI && chromeAIAvailable) {
                    try {
                        // Intentar con Writer API espec√≠fico
                        if (chromeAI.getCapabilities().writer) {
                            result = await chromeAI.writer(prompt, { tone, length });
                        } else {
                            // Fallback a Prompt API
                            result = await chromeAI.prompt(fullPrompt);
                        }
                    } catch (chromeError) {
                        console.warn('Chrome AI failed, using server:', chromeError);
                        // Fallback to server
                        const response = await fetch('/api/chat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: fullPrompt })
                        });
                        const data = await response.json();
                        result = data.response;
                    }
                } else {
                    // Usar servidor directamente
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: fullPrompt })
                    });
                    const data = await response.json();
                    result = data.response;
                }

                // Mostrar resultado
                const duration = performance.now() - startTime;
                outputDiv.innerHTML = `<div style="margin-bottom: 10px; font-size: 0.8rem; color: var(--text-secondary);">‚úÖ Generado en ${duration.toFixed(0)}ms</div><div>${result}</div>`;

            } catch (error) {
                console.error('Error generating text:', error);
                outputDiv.innerHTML = '<div style="color: var(--error-color);">‚ùå Error al generar el texto. Int√©ntalo de nuevo.</div>';
            }
        }

        function clearWriter() {
            document.getElementById('writerPrompt').value = '';
            document.getElementById('writerResult').style.display = 'none';
        }

        // === CORRECTOR ===
        async function correctText() {
            const text = document.getElementById('correctorText').value.trim();
            const outputDiv = document.getElementById('correctorOutput');
            const resultDiv = document.getElementById('correctorResult');

            if (!text) {
                alert('Por favor, introduce el texto que quieres corregir.');
                return;
            }

            try {
                const startTime = performance.now();
                
                // Mostrar loading
                outputDiv.innerHTML = '<div class="ai-loading">‚ö° Corrigiendo texto...</div>';
                resultDiv.style.display = 'block';

                // Crear prompt para correcci√≥n
                const fullPrompt = `Corrige la gram√°tica y ortograf√≠a del siguiente texto: ${text}`;

                let result;

                // Usar Chrome AI si est√° disponible
                if (chromeAI && chromeAIAvailable) {
                    try {
                        // Intentar con Proofreader API espec√≠fico
                        if (chromeAI.getCapabilities().proofreader) {
                            result = await chromeAI.proofreader(text);
                        } else {
                            // Fallback a Prompt API
                            result = await chromeAI.prompt(fullPrompt);
                        }
                    } catch (chromeError) {
                        console.warn('Chrome AI failed, using server:', chromeError);
                        // Fallback to server
                        const response = await fetch('/api/chat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: fullPrompt })
                        });
                        const data = await response.json();
                        result = data.response;
                    }
                } else {
                    // Usar servidor directamente
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: fullPrompt })
                    });
                    const data = await response.json();
                    result = data.response;
                }

                // Mostrar resultado
                const duration = performance.now() - startTime;
                outputDiv.innerHTML = `<div style="margin-bottom: 10px; font-size: 0.8rem; color: var(--text-secondary);">‚úÖ Corregido en ${duration.toFixed(0)}ms</div><div>${result}</div>`;

            } catch (error) {
                console.error('Error correcting text:', error);
                outputDiv.innerHTML = '<div style="color: var(--error-color);">‚ùå Error al corregir el texto. Int√©ntalo de nuevo.</div>';
            }
        }

        function clearCorrector() {
            document.getElementById('correctorText').value = '';
            document.getElementById('correctorResult').style.display = 'none';
        }

        // === TRADUCTOR ===
        async function translateText() {
            const text = document.getElementById('translatorText').value.trim();
            const sourceLang = document.getElementById('sourceLang').value;
            const targetLang = document.getElementById('targetLang').value;
            const outputDiv = document.getElementById('translatorOutput');
            const resultDiv = document.getElementById('translatorResult');

            if (!text) {
                alert('Por favor, introduce el texto que quieres traducir.');
                return;
            }

            if (sourceLang === targetLang && sourceLang !== 'auto') {
                alert('Por favor, selecciona idiomas diferentes.');
                return;
            }

            try {
                const startTime = performance.now();
                
                // Mostrar loading
                outputDiv.innerHTML = '<div class="ai-loading">‚ö° Traduciendo...</div>';
                resultDiv.style.display = 'block';

                // Crear prompt para traducci√≥n
                const fullPrompt = `Traduce el siguiente texto de ${sourceLang === 'auto' ? 'detecci√≥n autom√°tica' : sourceLang} a ${targetLang}: ${text}`;

                let result;

                // Usar Chrome AI si est√° disponible
                if (chromeAI && chromeAIAvailable) {
                    try {
                        // Intentar con Translator API espec√≠fico
                        if (chromeAI.getCapabilities().translator) {
                            result = await chromeAI.translator(text, { 
                                sourceLanguage: sourceLang, 
                                targetLanguage: targetLang 
                            });
                        } else {
                            // Fallback a Prompt API
                            result = await chromeAI.prompt(fullPrompt);
                        }
                    } catch (chromeError) {
                        console.warn('Chrome AI failed, using server:', chromeError);
                        // Fallback to server
                        const response = await fetch('/api/chat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: fullPrompt })
                        });
                        const data = await response.json();
                        result = data.response;
                    }
                } else {
                    // Usar servidor directamente
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: fullPrompt })
                    });
                    const data = await response.json();
                    result = data.response;
                }

                // Mostrar resultado
                const duration = performance.now() - startTime;
                outputDiv.innerHTML = `<div style="margin-bottom: 10px; font-size: 0.8rem; color: var(--text-secondary);">‚úÖ Traducido en ${duration.toFixed(0)}ms</div><div>${result}</div>`;

            } catch (error) {
                console.error('Error translating text:', error);
                outputDiv.innerHTML = '<div style="color: var(--error-color);">‚ùå Error al traducir el texto. Int√©ntalo de nuevo.</div>';
            }
        }

        function swapLanguages() {
            const sourceLang = document.getElementById('sourceLang');
            const targetLang = document.getElementById('targetLang');
            
            if (sourceLang.value !== 'auto') {
                const temp = sourceLang.value;
                sourceLang.value = targetLang.value;
                targetLang.value = temp;
            }
        }

        function clearTranslator() {
            document.getElementById('translatorText').value = '';
            document.getElementById('translatorResult').style.display = 'none';
        }

        // === RESUMIDOR ===
        async function summarizeText() {
            const text = document.getElementById('summarizerText').value.trim();
            const summaryType = document.getElementById('summaryType').value;
            const outputDiv = document.getElementById('summarizerOutput');
            const resultDiv = document.getElementById('summarizerResult');

            if (!text) {
                alert('Por favor, introduce el texto que quieres resumir.');
                return;
            }

            try {
                const startTime = performance.now();
                
                // Mostrar loading
                outputDiv.innerHTML = '<div class="ai-loading">‚ö° Resumiendo...</div>';
                resultDiv.style.display = 'block';

                // Crear prompt para resumen
                const summaryTypeText = summaryType === 'bullets' ? 'en puntos clave' : 
                                       summaryType === 'short' ? 'en forma corta' : 
                                       summaryType === 'detailed' ? 'de forma detallada' : 'de forma concisa';
                const fullPrompt = `Resume el siguiente texto ${summaryTypeText}: ${text}`;

                let result;

                // Usar Chrome AI si est√° disponible
                if (chromeAI && chromeAIAvailable) {
                    try {
                        // Intentar con Summarizer API espec√≠fico
                        if (chromeAI.getCapabilities().summarizer) {
                            const options = {
                                type: summaryType === 'bullets' ? 'key-points' : 'tl;dr',
                                length: summaryType === 'short' ? 'short' : summaryType === 'detailed' ? 'long' : 'medium'
                            };
                            result = await chromeAI.summarizer(text, options);
                        } else {
                            // Fallback a Prompt API
                            result = await chromeAI.prompt(fullPrompt);
                        }
                    } catch (chromeError) {
                        console.warn('Chrome AI failed, using server:', chromeError);
                        // Fallback to server
                        const response = await fetch('/api/chat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: fullPrompt })
                        });
                        const data = await response.json();
                        result = data.response;
                    }
                } else {
                    // Usar servidor directamente
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: fullPrompt })
                    });
                    const data = await response.json();
                    result = data.response;
                }

                // Mostrar resultado
                const duration = performance.now() - startTime;
                outputDiv.innerHTML = `<div style="margin-bottom: 10px; font-size: 0.8rem; color: var(--text-secondary);">‚úÖ Resumido en ${duration.toFixed(0)}ms</div><div>${result}</div>`;

            } catch (error) {
                console.error('Error summarizing text:', error);
                outputDiv.innerHTML = '<div style="color: var(--error-color);">‚ùå Error al resumir el texto. Int√©ntalo de nuevo.</div>';
            }
        }

        function clearSummarizer() {
            document.getElementById('summarizerText').value = '';
            document.getElementById('summarizerResult').style.display = 'none';
        }

        // === REESCRITOR ===
        async function rewriteText() {
            const text = document.getElementById('rewriterText').value.trim();
            const style = document.getElementById('rewriterStyle').value;
            const outputDiv = document.getElementById('rewriterOutput');
            const resultDiv = document.getElementById('rewriterResult');

            if (!text) {
                alert('Por favor, introduce el texto que quieres reescribir.');
                return;
            }

            try {
                const startTime = performance.now();
                
                // Mostrar loading
                outputDiv.innerHTML = '<div class="ai-loading">‚ö° Reescribiendo...</div>';
                resultDiv.style.display = 'block';

                // Crear prompt para reescritura
                const styleText = style === 'formal' ? 'de manera formal' : 
                                 style === 'casual' ? 'de manera casual' : 
                                 style === 'concise' ? 'de manera concisa' : 
                                 style === 'detailed' ? 'de manera detallada' : 'mejorando el estilo';
                const fullPrompt = `Reescribe el siguiente texto ${styleText}: ${text}`;

                let result;

                // Usar Chrome AI si est√° disponible
                if (chromeAI && chromeAIAvailable) {
                    try {
                        // Intentar con Rewriter API espec√≠fico
                        if (chromeAI.getCapabilities().rewriter) {
                            const options = {
                                tone: style === 'formal' ? 'formal' : style === 'casual' ? 'casual' : 'as-is',
                                length: style === 'concise' ? 'shorter' : style === 'detailed' ? 'longer' : 'as-is'
                            };
                            result = await chromeAI.rewriter(text, options);
                        } else {
                            // Fallback a Prompt API
                            result = await chromeAI.prompt(fullPrompt);
                        }
                    } catch (chromeError) {
                        console.warn('Chrome AI failed, using server:', chromeError);
                        // Fallback to server
                        const response = await fetch('/api/chat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: fullPrompt })
                        });
                        const data = await response.json();
                        result = data.response;
                    }
                } else {
                    // Usar servidor directamente
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: fullPrompt })
                    });
                    const data = await response.json();
                    result = data.response;
                }

                // Mostrar resultado
                const duration = performance.now() - startTime;
                outputDiv.innerHTML = `<div style="margin-bottom: 10px; font-size: 0.8rem; color: var(--text-secondary);">‚úÖ Reescrito en ${duration.toFixed(0)}ms</div><div>${result}</div>`;

            } catch (error) {
                console.error('Error rewriting text:', error);
                outputDiv.innerHTML = '<div style="color: var(--error-color);">‚ùå Error al reescribir el texto. Int√©ntalo de nuevo.</div>';
            }
        }

        function clearRewriter() {
            document.getElementById('rewriterText').value = '';
            document.getElementById('rewriterResult').style.display = 'none';
        }

        // === CORRECTOR DE PRUEBAS ===
        async function proofreadText() {
            const text = document.getElementById('proofreaderText').value.trim();
            const level = document.getElementById('proofreadingLevel').value;
            const outputDiv = document.getElementById('proofreaderOutput');
            const resultDiv = document.getElementById('proofreaderResult');

            if (!text) {
                alert('Por favor, introduce el texto que quieres revisar.');
                return;
            }

            try {
                const startTime = performance.now();
                
                // Mostrar loading
                outputDiv.innerHTML = '<div class="ai-loading">‚ö° Revisando texto...</div>';
                resultDiv.style.display = 'block';

                // Crear prompt para revisi√≥n
                const levelText = level === 'academic' ? 'nivel acad√©mico' : 
                                 level === 'creative' ? 'nivel creativo' : 
                                 'nivel general';
                const fullPrompt = `Revisa y corrige el siguiente texto a ${levelText}, buscando errores gramaticales, ortogr√°ficos y de estilo: ${text}`;

                let result;

                // Usar Chrome AI si est√° disponible
                if (chromeAI && chromeAIAvailable) {
                    try {
                        // Intentar con Proofreader API espec√≠fico
                        if (chromeAI.getCapabilities().proofreader) {
                            const options = {
                                context: level === 'academic' ? 'academic' : level === 'creative' ? 'creative' : 'general'
                            };
                            result = await chromeAI.proofreader(text, options);
                        } else {
                            // Fallback a Prompt API
                            result = await chromeAI.prompt(fullPrompt);
                        }
                    } catch (chromeError) {
                        console.warn('Chrome AI failed, using server:', chromeError);
                        // Fallback to server
                        const response = await fetch('/api/chat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: fullPrompt })
                        });
                        const data = await response.json();
                        result = data.response;
                    }
                } else {
                    // Usar servidor directamente
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: fullPrompt })
                    });
                    const data = await response.json();
                    result = data.response;
                }

                // Mostrar resultado
                const duration = performance.now() - startTime;
                outputDiv.innerHTML = `<div style="margin-bottom: 10px; font-size: 0.8rem; color: var(--text-secondary);">‚úÖ Revisado en ${duration.toFixed(0)}ms</div><div>${result}</div>`;

            } catch (error) {
                console.error('Error proofreading text:', error);
                outputDiv.innerHTML = '<div style="color: var(--error-color);">‚ùå Error al revisar el texto. Int√©ntalo de nuevo.</div>';
            }
        }

        function clearProofreader() {
            document.getElementById('proofreaderText').value = '';
            document.getElementById('proofreaderResult').style.display = 'none';
        }

        // === UTILIDADES COMUNES ===
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Feedback visual
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ ¬°Copiado!';
                button.style.background = 'var(--success-color)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('Error al copiar al portapapeles');
            });
        }

        function insertToChat(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            const messageInput = document.getElementById('messageInput');
            
            if (messageInput) {
                messageInput.value = text;
                messageInput.focus();
                
                // Cerrar el modal
                const modal = element.closest('.ai-modal');
                if (modal) {
                    closeAIModal(modal.id);
                }
                
                // Feedback visual
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ ¬°Enviado!';
                button.style.background = 'var(--success-color)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }
        }
    </script>

    <!-- Scripts de desarrollo (solo se cargan en entorno local) -->
    <script>
        // Verificar si estamos en entorno de desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Funci√≥n para habilitar las herramientas de desarrollo
            function enableDevTools() {
                console.log('üõ†Ô∏è Herramientas de desarrollo habilitadas');
                
                // Exponer funciones √∫tiles para depuraci√≥n
                window.debugChat = {
                    clearMessages: function() {
                        document.querySelector('.chat-messages').innerHTML = '';
                        console.log('Mensajes borrados');
                    },
                    simulateError: function() {
                        console.error('Error simulado para pruebas');
                        throw new Error('Error simulado para pruebas');
                    },
                    toggleTestMode: function() {
                        document.body.classList.toggle('test-mode');
                        console.log('Modo de prueba: ' + (document.body.classList.contains('test-mode') ? 'activado' : 'desactivado'));
                    }
                };
            }
            
            // Habilitar herramientas de desarrollo
            enableDevTools();
        }
    </script>
    
    <!-- Modal de Personalizaci√≥n -->
    <div id="customizeModal" class="customize-modal" style="display: none;">
        <div class="customize-modal-content">
            <div class="customize-modal-header">
                <h3>‚öôÔ∏è Personalizar Interfaz</h3>
                <button class="close-modal" aria-label="Cerrar personalizaci√≥n">&times;</button>
            </div>
            <div class="customize-modal-body">
                <!-- Temas de Color -->
                <div class="customize-section">
                    <h4>üé® Tema de Color</h4>
                    <div class="theme-options">
                        <button class="theme-btn" data-theme="cyberpunk" style="background: linear-gradient(45deg, #ff006e, #00f5ff);">Cyberpunk</button>
                        <button class="theme-btn" data-theme="neon-green" style="background: linear-gradient(45deg, #39ff14, #00ff88);">Neon Verde</button>
                        <button class="theme-btn" data-theme="sunset" style="background: linear-gradient(45deg, #ff6b35, #f7931e);">Atardecer</button>
                        <button class="theme-btn" data-theme="purple-rain" style="background: linear-gradient(45deg, #667eea, #764ba2);">Lluvia P√∫rpura</button>
                        <button class="theme-btn" data-theme="default" style="background: linear-gradient(45deg, #667eea, #764ba2);">Original</button>
                    </div>
                </div>
                
                <!-- Tama√±o de Fuente -->
                <div class="customize-section">
                    <h4>üìù Tama√±o de Fuente</h4>
                    <div class="font-size-controls">
                        <button class="font-btn" data-size="small">Peque√±o</button>
                        <button class="font-btn" data-size="medium">Mediano</button>
                        <button class="font-btn" data-size="large">Grande</button>
                    </div>
                </div>
                
                <!-- Avatar del Bot -->
                <div class="customize-section">
                    <h4>ü§ñ Avatar del Bot</h4>
                    <div class="avatar-options">
                        <button class="avatar-btn" data-avatar="ü§ñ">ü§ñ Robot</button>
                        <button class="avatar-btn" data-avatar="üß†">üß† Cerebro</button>
                        <button class="avatar-btn" data-avatar="‚ú®">‚ú® Estrella</button>
                        <button class="avatar-btn" data-avatar="üíé">üíé Diamante</button>
                        <button class="avatar-btn" data-avatar="üîÆ">üîÆ Cristal</button>
                    </div>
                </div>

                <!-- Chrome AI Configuration -->
                <div class="customize-section">
                    <h4>‚öôÔ∏è Configuraci√≥n Chrome AI</h4>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                        Configura Chrome Built-in AI para usar las funciones localmente
                    </p>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <a href="/chrome-ai-setup" target="_blank" class="ai-btn primary" style="text-decoration: none; display: inline-block; padding: 10px 20px; margin: 5px;">
                            ü§ñ Configurar Chrome AI
                        </a>
                    </div>
                </div>

                <!-- Chrome AI Tools -->
                <div class="customize-section">
                    <h4>üß† Herramientas Chrome AI</h4>
                    <div id="ai-status-indicator" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; font-size: 0.85rem;">
                        <div>Estado: <span id="ai-status-text">Inicializando...</span></div>
                        <div>Chrome AI: <span id="chrome-ai-status">‚ùì</span> | Gemini Fallback: <span id="gemini-status">‚úÖ</span></div>
                        <div id="performance-indicator" style="font-size: 0.75rem; margin-top: 5px; opacity: 0.8;">
                            Rendimiento: <span id="performance-stats">Midiendo...</span>
                        </div>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                        Sistema h√≠brido: Chrome AI local + Gemini API como respaldo
                    </p>
                    <div class="chrome-ai-tools">
                        <button class="ai-tool-btn ai-writer-btn" aria-label="Escritor AI" style="display: flex !important; visibility: visible !important;">
                            <span class="ai-tool-icon">‚úçÔ∏è</span>
                            <div class="ai-tool-info">
                                <strong>Escritor AI</strong>
                                <small>Genera texto con diferentes tonos</small>
                            </div>
                        </button>
                        <button class="ai-tool-btn ai-corrector-btn" aria-label="Corrector autom√°tico" style="display: flex !important; visibility: visible !important;">
                            <span class="ai-tool-icon">‚úÖ</span>
                            <div class="ai-tool-info">
                                <strong>Corrector</strong>
                                <small>Corrige gram√°tica autom√°ticamente</small>
                            </div>
                        </button>
                        <button class="ai-tool-btn ai-translator-btn" aria-label="Traductor instant√°neo" style="display: flex !important; visibility: visible !important;">
                            <span class="ai-tool-icon">üåê</span>
                            <div class="ai-tool-info">
                                <strong>Traductor</strong>
                                <small>Traduce a 9 idiomas instant√°neamente</small>
                            </div>
                        </button>
                        <button class="ai-tool-btn ai-summarizer-btn" aria-label="Resumidor AI" style="display: flex !important; visibility: visible !important;">
                            <span class="ai-tool-icon">üìÑ</span>
                            <div class="ai-tool-info">
                                <strong>Resumidor</strong>
                                <small>Resume textos largos autom√°ticamente</small>
                            </div>
                        </button>
                        <button class="ai-tool-btn ai-rewriter-btn" aria-label="Reescritor AI" style="display: flex !important; visibility: visible !important;">
                            <span class="ai-tool-icon">üñäÔ∏è</span>
                            <div class="ai-tool-info">
                                <strong>Reescritor</strong>
                                <small>Mejora y reformula el texto</small>
                            </div>
                        </button>
                        <button class="ai-tool-btn ai-proofreader-btn" aria-label="Corrector de Pruebas AI" style="display: flex !important; visibility: visible !important;">
                            <span class="ai-tool-icon">üìñ</span>
                            <div class="ai-tool-info">
                                <strong>Corrector de Pruebas</strong>
                                <small>Revisa gram√°tica y estilo</small>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Escritor AI -->
    <div id="writerModal" class="ai-modal" style="display: none;">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>‚úçÔ∏è Escritor AI</h3>
                <button class="close-ai-modal" data-modal="writerModal">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-section">
                    <label for="writerPrompt">Describe lo que quieres escribir:</label>
                    <textarea id="writerPrompt" placeholder="Ej: Escribe un email profesional para solicitar una reuni√≥n..."></textarea>
                </div>
                <div class="ai-section">
                    <label for="writerTone">Tono:</label>
                    <select id="writerTone">
                        <option value="formal">Formal</option>
                        <option value="casual">Casual</option>
                        <option value="friendly">Amigable</option>
                        <option value="professional">Profesional</option>
                        <option value="creative">Creativo</option>
                    </select>
                </div>
                <div class="ai-section">
                    <label for="writerLength">Longitud:</label>
                    <select id="writerLength">
                        <option value="short">Corto</option>
                        <option value="medium">Mediano</option>
                        <option value="long">Largo</option>
                    </select>
                </div>
                <div class="ai-actions">
                    <button class="ai-btn primary" onclick="generateText()">‚ú® Generar Texto</button>
                    <button class="ai-btn secondary" onclick="clearWriter()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="ai-result" id="writerResult" style="display: none;">
                    <h4>üìù Resultado:</h4>
                    <div class="ai-output" id="writerOutput"></div>
                    <div class="ai-actions">
                        <button class="ai-btn" onclick="copyToClipboard('writerOutput')">üìã Copiar</button>
                        <button class="ai-btn" onclick="insertToChat('writerOutput')">üí¨ Enviar al Chat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Corrector -->
    <div id="correctorModal" class="ai-modal" style="display: none;">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>‚úÖ Corrector Autom√°tico</h3>
                <button class="close-ai-modal" data-modal="correctorModal">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-section">
                    <label for="correctorText">Texto a corregir:</label>
                    <textarea id="correctorText" placeholder="Pega aqu√≠ el texto que quieres corregir..."></textarea>
                </div>
                <div class="ai-actions">
                    <button class="ai-btn primary" onclick="correctText()">üîç Corregir Texto</button>
                    <button class="ai-btn secondary" onclick="clearCorrector()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="ai-result" id="correctorResult" style="display: none;">
                    <h4>‚úÖ Texto Corregido:</h4>
                    <div class="ai-output" id="correctorOutput"></div>
                    <div class="ai-actions">
                        <button class="ai-btn" onclick="copyToClipboard('correctorOutput')">üìã Copiar</button>
                        <button class="ai-btn" onclick="insertToChat('correctorOutput')">üí¨ Enviar al Chat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Traductor -->
    <div id="translatorModal" class="ai-modal" style="display: none;">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>üåê Traductor Instant√°neo</h3>
                <button class="close-ai-modal" data-modal="translatorModal">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-section">
                    <label for="translatorText">Texto a traducir:</label>
                    <textarea id="translatorText" placeholder="Escribe o pega el texto que quieres traducir..."></textarea>
                </div>
                <div class="ai-section">
                    <div class="translator-languages">
                        <div class="language-group">
                            <label for="sourceLang">Desde:</label>
                            <select id="sourceLang">
                                <option value="auto">Detectar autom√°ticamente</option>
                                <option value="es">Espa√±ol</option>
                                <option value="en">Ingl√©s</option>
                                <option value="fr">Franc√©s</option>
                                <option value="de">Alem√°n</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Portugu√©s</option>
                                <option value="ja">Japon√©s</option>
                                <option value="ko">Coreano</option>
                                <option value="zh">Chino</option>
                            </select>
                        </div>
                        <div class="language-swap">
                            <button class="ai-btn swap-btn" onclick="swapLanguages()">üîÑ</button>
                        </div>
                        <div class="language-group">
                            <label for="targetLang">Hacia:</label>
                            <select id="targetLang">
                                <option value="en">Ingl√©s</option>
                                <option value="es">Espa√±ol</option>
                                <option value="fr">Franc√©s</option>
                                <option value="de">Alem√°n</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Portugu√©s</option>
                                <option value="ja">Japon√©s</option>
                                <option value="ko">Coreano</option>
                                <option value="zh">Chino</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="ai-actions">
                    <button class="ai-btn primary" onclick="translateText()">üåê Traducir</button>
                    <button class="ai-btn secondary" onclick="clearTranslator()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="ai-result" id="translatorResult" style="display: none;">
                    <h4>üåê Traducci√≥n:</h4>
                    <div class="ai-output" id="translatorOutput"></div>
                    <div class="ai-actions">
                        <button class="ai-btn" onclick="copyToClipboard('translatorOutput')">üìã Copiar</button>
                        <button class="ai-btn" onclick="insertToChat('translatorOutput')">üí¨ Enviar al Chat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Resumidor AI -->
    <div id="summarizerModal" class="ai-modal" style="display: none;">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>üìÑ Resumidor AI</h3>
                <button class="close-ai-modal" data-modal="summarizerModal">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-section">
                    <label for="summarizerText">Texto a resumir:</label>
                    <textarea id="summarizerText" placeholder="Pega aqu√≠ el texto que quieres resumir..." rows="8"></textarea>
                </div>
                <div class="ai-section">
                    <label for="summaryType">Tipo de resumen:</label>
                    <select id="summaryType">
                        <option value="short">Resumen corto</option>
                        <option value="medium">Resumen mediano</option>
                        <option value="detailed">Resumen detallado</option>
                        <option value="bullets">Puntos clave</option>
                    </select>
                </div>
                <div class="ai-actions">
                    <button class="ai-btn primary" onclick="summarizeText()">üìÑ Resumir</button>
                    <button class="ai-btn secondary" onclick="clearSummarizer()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="ai-result" id="summarizerResult" style="display: none;">
                    <h4>üìÑ Resumen:</h4>
                    <div class="ai-output" id="summarizerOutput"></div>
                    <div class="ai-actions">
                        <button class="ai-btn" onclick="copyToClipboard('summarizerOutput')">üìã Copiar</button>
                        <button class="ai-btn" onclick="insertToChat('summarizerOutput')">üí¨ Enviar al Chat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Reescritor AI -->
    <div id="rewriterModal" class="ai-modal" style="display: none;">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>üñäÔ∏è Reescritor AI</h3>
                <button class="close-ai-modal" data-modal="rewriterModal">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-section">
                    <label for="rewriterText">Texto a reescribir:</label>
                    <textarea id="rewriterText" placeholder="Escribe o pega el texto que quieres mejorar..." rows="6"></textarea>
                </div>
                <div class="ai-section">
                    <label for="rewriterStyle">Estilo de reescritura:</label>
                    <select id="rewriterStyle">
                        <option value="improve">Mejorar claridad</option>
                        <option value="formal">M√°s formal</option>
                        <option value="casual">M√°s casual</option>
                        <option value="concise">M√°s conciso</option>
                        <option value="detailed">M√°s detallado</option>
                        <option value="professional">Profesional</option>
                        <option value="creative">Creativo</option>
                    </select>
                </div>
                <div class="ai-actions">
                    <button class="ai-btn primary" onclick="rewriteText()">üñäÔ∏è Reescribir</button>
                    <button class="ai-btn secondary" onclick="clearRewriter()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="ai-result" id="rewriterResult" style="display: none;">
                    <h4>üñäÔ∏è Texto Reescrito:</h4>
                    <div class="ai-output" id="rewriterOutput"></div>
                    <div class="ai-actions">
                        <button class="ai-btn" onclick="copyToClipboard('rewriterOutput')">üìã Copiar</button>
                        <button class="ai-btn" onclick="insertToChat('rewriterOutput')">üí¨ Enviar al Chat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Corrector de Pruebas AI -->
    <div id="proofreaderModal" class="ai-modal" style="display: none;">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>üìñ Corrector de Pruebas AI</h3>
                <button class="close-ai-modal" data-modal="proofreaderModal">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-section">
                    <label for="proofreaderText">Texto a revisar:</label>
                    <textarea id="proofreaderText" placeholder="Escribe o pega el texto que quieres revisar..." rows="6"></textarea>
                </div>
                <div class="ai-section">
                    <label for="proofreadingLevel">Nivel de correcci√≥n:</label>
                    <select id="proofreadingLevel">
                        <option value="basic">B√°sico (Gram√°tica y ortograf√≠a)</option>
                        <option value="advanced">Avanzado (Estilo y claridad)</option>
                        <option value="academic">Acad√©mico (Formal y preciso)</option>
                        <option value="creative">Creativo (Fluidez y expresi√≥n)</option>
                    </select>
                </div>
                <div class="ai-actions">
                    <button class="ai-btn primary" onclick="proofreadText()">üìñ Revisar</button>
                    <button class="ai-btn secondary" onclick="clearProofreader()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="ai-result" id="proofreaderResult" style="display: none;">
                    <h4>üìñ Texto Corregido:</h4>
                    <div class="ai-output" id="proofreaderOutput"></div>
                    <div class="ai-actions">
                        <button class="ai-btn" onclick="copyToClipboard('proofreaderOutput')">üìã Copiar</button>
                        <button class="ai-btn" onclick="insertToChat('proofreaderOutput')">üí¨ Enviar al Chat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chrome Built-in AI Integration -->
    <script src="{{ url_for('static', filename='js/chrome-ai-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    
    <!-- DEBUG CHROME AI BUTTONS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('üîç DEBUGGING CHROME AI BUTTONS...');
                const chromeAISection = document.querySelector('.chrome-ai-tools');
                const aiButtons = document.querySelectorAll('.ai-tool-btn');
                
                console.log('Chrome AI Section:', chromeAISection);
                console.log('AI Tool Buttons found:', aiButtons.length);
                
                aiButtons.forEach((btn, index) => {
                    console.log(`Button ${index}:`, btn);
                    console.log(`Button ${index} style:`, window.getComputedStyle(btn));
                    console.log(`Button ${index} display:`, window.getComputedStyle(btn).display);
                    console.log(`Button ${index} visibility:`, window.getComputedStyle(btn).visibility);
                });
                
                // Forzar visibilidad adicional
                aiButtons.forEach(btn => {
                    btn.style.display = 'flex';
                    btn.style.visibility = 'visible';
                    btn.style.opacity = '1';
                    btn.style.height = '60px';
                    btn.style.border = '2px solid red'; // Para debugging visual
                });
            }, 2000);
        });
    </script>
</body>
</html>
