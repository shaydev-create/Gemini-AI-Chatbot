<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-buster" content="v1.0.1-20250112-fix">
    <meta name="description" content="Chat con Gemini AI - Experimenta conversaciones inteligentes con la IA m√°s avanzada. Interfaz moderna y respuestas instant√°neas.">
    <meta name="keywords" content="chat AI, Gemini, conversaci√≥n inteligente, chatbot, asistente virtual">
    <meta name="author" content="Gemini AI Team">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://gemini-ai.com/chat">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Chat - Gemini AI">
    <meta property="og:description" content="Experimenta conversaciones inteligentes con la IA m√°s avanzada">
    <meta property="og:image" content="https://gemini-ai.com/static/images/chat-og-image.jpg">
    <meta property="og:url" content="https://gemini-ai.com/chat">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Chat - Gemini AI">
    <meta name="twitter:description" content="Experimenta conversaciones inteligentes con la IA m√°s avanzada">
    <meta name="twitter:image" content="https://gemini-ai.com/static/images/chat-twitter-card.jpg">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#00f5ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/static/manifest.json">
    
    
    <title>{{ translate('title') }}</title>
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Gemini AI Chat",
      "description": "Chat con Gemini AI - Experimenta conversaciones inteligentes con la IA m√°s avanzada",
      "url": "https://gemini-ai.com/chat",
      "applicationCategory": "ChatApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Gemini AI Team"
      }
    }
    </script>
    <style>
        :root {
            --primary: #00f5ff;
            --secondary: #1e3a8a;
            --accent: #3b82f6;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff0066;
            --bot-color: var(--primary);
            --user-color: var(--secondary);

            --bg-card: rgba(255, 255, 255, 0.02);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --glass-bg: rgba(0, 245, 255, 0.008); /* ULTRA TRANSPARENTE */
            --glass-border: rgba(0, 245, 255, 0.03); /* ULTRA TRANSPARENTE */       
            --glow: 0 0 20px var(--primary);
            --neural-grid: linear-gradient(90deg, transparent 98%, rgba(0, 245, 255, 0.1) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        /* Accessibility Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary);
            color: #0a0a0f;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 9999;
            font-weight: bold;
            transition: top 0.3s ease;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Keyboard navigation improvements */
        .send-button:focus,
        .action-btn:focus,
        .back-btn:focus,
        input:focus,
        button:focus {
            outline: 3px solid #00d4ff;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.3);
        }
        
        .send-button:focus,
        .action-btn:focus {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* Ensure all interactive elements are keyboard accessible */
        .send-button,
        .action-btn,
        .back-btn {
            cursor: pointer;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        #neural-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        

        

        
        .chat-container {
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            background: rgba(5, 10, 20, 0.25); /* Mucho m√°s transparente para resaltar el fondo */
            border-radius: 24px;
            backdrop-filter: blur(2px); /* Blur m√≠nimo para ver el fondo */
            border: 1px solid rgba(100, 150, 255, 0.15);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.2), 
                0 0 0 1px rgba(255, 255, 255, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .chat-header {
            background: var(--glass-bg);
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-header-content {
            flex: 1;
            text-align: center;
        }
        
        .chat-header h1 {
            margin-bottom: 5px;
            font-size: 1.8rem;
            font-weight: 700;
            animation: title-glow 2s ease-in-out infinite alternate;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .title-emoji {
            font-size: 1.8rem;
            /* El emoji mantiene sus colores naturales */
        }
        
        .title-text {
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes title-glow {
            0% { filter: drop-shadow(0 0 10px var(--primary)); }
            100% { filter: drop-shadow(0 0 20px var(--secondary)); }
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        

        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            max-width: 80%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message.bot {
            align-self: flex-start;
        }
        
        .message-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: 2px solid rgba(0, 245, 255, 0.5);
            box-shadow: var(--glow);
        }
        
        .message.bot .message-avatar::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: var(--success-color);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            border: 2px solid rgba(30, 58, 138, 0.5);
            box-shadow: 0 0 20px var(--secondary);
        }
        
        .message-content {
            background: rgba(5, 10, 20, 0.15); /* Mucho m√°s transparente */
            padding: 14px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            border: 1px solid rgba(100, 150, 255, 0.1);
            position: relative;
            backdrop-filter: blur(3px); /* Blur m√≠nimo */
            line-height: 1.5;
        }
        
        .message.bot .message-content {
            background: rgba(0, 245, 255, 0.05); /* Muy transparente */
            border-color: rgba(0, 245, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 245, 255, 0.1);
        }
        
        .message.user .message-content {
            background: rgba(30, 58, 138, 0.05); /* Muy transparente */
            border-color: rgba(30, 58, 138, 0.15);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            opacity: 0.7;
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid rgba(100, 150, 255, 0.1);
            background: rgba(5, 10, 20, 0.1); /* Muy transparente */
        }
        
        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .chat-input input {
            width: 100%;
            padding: 16px 24px;
            padding-right: 70px;
            border: 2px solid rgba(100, 150, 255, 0.15);
            border-radius: 25px;
            background: rgba(5, 10, 20, 0.2); /* M√°s transparente */
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            backdrop-filter: blur(3px); /* Blur m√≠nimo */
            transition: all 0.3s ease;
            resize: none;
            min-height: 54px;
            max-height: 120px;
        }
        
        .chat-input input::placeholder {
            color: var(--text-secondary);
        }
        
        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }
        
        .char-counter {
            position: absolute;
            bottom: 8px;
            right: 15px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            pointer-events: none;
        }
        
        .send-button {
            padding: 16px 28px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--glow);
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 54px;
        }
        
        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 245, 255, 0.4);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
        }
        
        /* Estilos para los botones de idioma */
        .lang-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-width: 90px;
        }
        
        .lang-btn[data-lang="es"] {
            order: 4; /* Ordenar despu√©s de los otros botones */
        }
        
        .lang-btn[data-lang="en"] {
            order: 5; /* Ordenar despu√©s del bot√≥n espa√±ol */
        }
        
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            margin-left: 50px;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #4ecdc4;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 20px;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 25px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .back-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.4);
        }
        
        /* Scrollbar personalizada */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Responsive Design Mejorado */
        @media (max-width: 768px) {
            .chat-container {
                width: 98%;
                height: 95vh;
                border-radius: 16px;
            }
            
            .chat-header {
                padding: 15px;
            }
            
            .chat-header h1 {
                font-size: 1.5rem;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .message-avatar {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .chat-input {
                padding: 15px;
            }
            
            .input-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .send-button {
                width: 100%;
                justify-content: center;
            }
            
            .input-actions {
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px;
            }
            
            .action-btn {
                flex: 1;
                min-width: 80px;
                text-align: center;
                font-size: 0.75rem;
                padding: 6px 8px;
            }
            
            .lang-btn {
                min-width: 70px;
            }
        }
        
        @media (max-width: 480px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .back-btn {
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .chat-header {
                padding: 12px;
            }
            
            .chat-header h1 {
                font-size: 1.3rem;
            }
            

            
            .message-content {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .action-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    
    <canvas id="neural-canvas"></canvas>
    <a href="#main-chat" class="skip-link">{{ translate('welcome') }}</a>
    <div id="chat-container" role="main" aria-label="Chat principal">
        <!-- Skip to main content for accessibility -->
        <a href="#chat-main" class="skip-link" aria-label="Saltar al contenido principal del chat">Saltar al chat</a>
        
        <nav aria-label="Navegaci√≥n principal">
            <a href="/" class="back-btn" aria-label="Volver a la p√°gina principal">‚Üê Volver</a>
        </nav>


        <!-- √önico contenedor requerido por E2E Selenium y la app -->
        <div id="chatContainer" class="chat-container" role="main">
            <header class="chat-header">
                <div class="chat-header-content">
                    <h1><span class="title-emoji">ü§ñ</span> <span class="title-text">Gemini AI Chat</span></h1>
                    <div class="chat-status" role="status" aria-live="polite">
                        <div class="status-dot" aria-hidden="true"></div>
                        <span>Asistente en l√≠nea</span>
                    </div>
                </div>
            </header>
            <section class="chat-messages" id="messages" role="log" aria-live="polite" aria-label="Historial de conversaci√≥n">
            </section>
            <div class="typing-indicator" id="typing" role="status" aria-live="polite" aria-label="Indicador de escritura">
                <span>El asistente est√° escribiendo</span>
                <div class="typing-dots" aria-hidden="true">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <section class="chat-input" aria-label="√Årea de entrada de mensajes">
                <form class="input-container" onsubmit="sendMessage(); return false;">
                    <div class="input-wrapper">
                        <label for="messageInput" class="sr-only">Escribe tu mensaje</label>
                        <input type="text" id="messageInput" placeholder="Escribe tu mensaje aqu√≠..." maxlength="1000" aria-describedby="charCounter" aria-required="true" autocomplete="off" />
                        <div class="char-counter" id="charCounter" aria-live="polite">0/1000</div>
                    </div>
                    <button type="submit" class="send-button" id="sendButton" aria-label="Enviar mensaje">
                        <span>Enviar</span>
                        <span aria-hidden="true">üì§</span>
                    </button>
                </form>
                <div class="input-actions" role="toolbar" aria-label="Acciones del chat">
                    <button class="action-btn" aria-label="Limpiar historial del chat" tabindex="0">üóëÔ∏è Limpiar chat</button>
                    <button class="action-btn" aria-label="Exportar conversaci√≥n" tabindex="0">üíæ Exportar</button>
                    <button class="action-btn" aria-label="Activar o desactivar s√≠ntesis de voz" tabindex="0">üé§ Voz</button>
                    <button class="action-btn" aria-label="Subir archivo" tabindex="0">üìé Archivo</button>
                    <button class="action-btn lang-btn" data-lang="es" aria-label="Cambiar a espa√±ol" tabindex="0">üá™üá∏ Espa√±ol</button>
                    <button class="action-btn lang-btn" data-lang="en" aria-label="Cambiar a ingl√©s" tabindex="0">üá¨üáß English</button>
                </div>
                <input type="file" id="fileInput" style="display: none;" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple aria-label="Seleccionar archivos para subir">
            </section>
        </div>
    </div>
    <!-- El selector de idioma se ha movido a los botones de acci√≥n del chat -->
    <script>
        // === CONFIGURACI√ìN OPTIMIZADA Y VARIABLES GLOBALES ===
        let messagesContainer, messageInput, sendButton, typingIndicator, charCounter;
        let isVoiceEnabled = false;
        let chatHistory = [];
        let isLoading = false;
        let currentMessageId = 0;
        let lastScrollPosition = 0;
        let autoScrollEnabled = true;
        let retryCount = 0;
        let conversationId = 'session_' + Date.now(); // ID √∫nico para la conversaci√≥n actual
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000;
        const MAX_MESSAGE_LENGTH = 4000;
        const TYPING_SPEED = 30;
        const particles = [];
        const MAX_PARTICLES = 30; // Reducido para mejor rendimiento
        let animationId;
        let lastParticleTime = 0;
        const PARTICLE_INTERVAL = 150; // Aumentado para reducir carga
        
        // requestAnimationFrame loop to guarantee input is always enabled
        function forceEnableInput() {
            if (messageInput) {
                if (messageInput.disabled) {
                    console.warn('Input was disabled, forcibly enabling.');
                    messageInput.disabled = false;
                }
                requestAnimationFrame(forceEnableInput);
            }
        }
        
        // Cache de elementos DOM para evitar b√∫squedas repetidas
        const domCache = {
            chatMessages: null,
            messageInput: null,
            sendButton: null,
            typingIndicator: null,
            particleContainer: null
        };
        
        // Configuraci√≥n de rendimiento
        const PERFORMANCE_CONFIG = {
            enableParticles: true,
            enableAnimations: true,
            enableSmoothScroll: true,
            debounceDelay: 300,
            throttleDelay: 16 // ~60fps
        };
        
        // M√©tricas de rendimiento del cliente
        let clientMetrics = {
            messagesCount: 0,
            averageResponseTime: 0,
            lastMessageTime: 0,
            cacheHits: 0
        };
        

        
        // === FUNCIONES DE UTILIDAD OPTIMIZADAS ===
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // Cache de elementos DOM
        function initDOMCache() {
            domCache.chatMessages = document.getElementById('messages');
            domCache.messageInput = document.getElementById('messageInput');
            domCache.sendButton = document.getElementById('sendButton');
            domCache.typingIndicator = document.getElementById('typing');
            domCache.particleContainer = document.body;
        }
        
        // Funci√≥n optimizada para obtener elementos del DOM
        function getElement(key) {
            if (!domCache[key]) {
                switch(key) {
                    case 'chatMessages':
                        domCache[key] = document.getElementById('messages');
                        break;
                    case 'messageInput':
                        domCache[key] = document.getElementById('messageInput');
                        break;
                    case 'sendButton':
                        domCache[key] = document.getElementById('sendButton');
                        break;
                    case 'typingIndicator':
                        domCache[key] = document.getElementById('typing');
                        break;
                    case 'particleContainer':
                        domCache[key] = document.body;
                        break;
                }
            }
            return domCache[key];
        }
        
        // Funci√≥n para limpiar cache DOM cuando sea necesario
        function clearDOMCache() {
            Object.keys(domCache).forEach(key => {
                domCache[key] = null;
            });
        }
        
        // Funciones principales (deben estar en scope global)
        function addMessage(text, sender, timestamp = null) {
            try {
                if (!messagesContainer) {
                    console.error('messagesContainer no est√° disponible');
                    return;
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                
                // Emojis mejorados para el bot y usuario
                if (sender === 'user') {
                    avatar.innerHTML = 'üë®‚Äçüíª';
                } else {
                    avatar.innerHTML = 'ü§ñ';
                }
                
                const contentWrapper = document.createElement('div');
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = text;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = timestamp || new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                contentWrapper.appendChild(content);
                contentWrapper.appendChild(timeDiv);
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentWrapper);
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Guardar en historial
                chatHistory.push({
                    text: text,
                    sender: sender,
                    timestamp: timestamp || new Date().toISOString()
                });
                
                // Animaci√≥n de entrada
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    messageDiv.style.transition = 'all 0.3s ease';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 100);
            } catch (error) {
                console.error('Error al agregar mensaje:', error);
            }
        }
        
        function showTyping() {
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Actualizar estado del bot
                const statusText = document.querySelector('.chat-status span');
                if (statusText) statusText.textContent = 'Escribiendo...';
            }
        }
        
        function hideTyping() {
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
                
                // Restaurar estado del bot
                const statusText = document.querySelector('.chat-status span');
                if (statusText) statusText.textContent = 'Asistente en l√≠nea';
            }
        }
        
        // === ENV√çO DE MENSAJES OPTIMIZADO ===
        async function sendMessage() {
            const messageInput = getElement('messageInput') || document.getElementById('messageInput');
            const sendButton = getElement('sendButton') || document.getElementById('sendButton');
            
            if (!messageInput || !sendButton) return;
            
            const message = messageInput.value.trim();
            
            if (!message || isLoading) return;
            
            if (message.length > 1000) {
                showNotification('El mensaje es demasiado largo (m√°ximo 1000 caracteres)', 'warning');
                return;
            }
            
            const startTime = performance.now();
            
            // Solo deshabilitar el bot√≥n, nunca el input
            isLoading = true;
            // Forzar input siempre habilitado
            messageInput.disabled = false;
            sendButton.disabled = true;
            sendButton.innerHTML = '<span>Enviando...</span><span>‚è≥</span>';
            
            // Agregar mensaje del usuario
            addMessage(message, 'user');
            messageInput.value = '';
            updateCharCounter();
            
            // Mostrar indicador de escritura
            showTyping();
            
            try {
                // Usar AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
                
                // Determinar la URL base (preferir HTTPS)
                const protocol = window.location.protocol;
                const host = window.location.host;
                let apiUrl = '/api/chat/send';
                
                // Usar siempre el mismo protocolo que la p√°gina
                // Comentado el intento de actualizar a HTTPS ya que causa problemas
                /*
                if (protocol === 'http:' && (host.includes('localhost') || host.includes('127.0.0.1'))) {
                    // Verificar si HTTPS est√° disponible
                    try {
                        const httpsUrl = `https://${host}/api/chat/send`;
                        const testResponse = await fetch(httpsUrl, {
                            method: 'HEAD',
                            signal: AbortSignal.timeout(2000)
                        });
                        if (testResponse.ok || testResponse.status < 500) {
                            apiUrl = httpsUrl;
                            console.log('‚úÖ Usando HTTPS para API requests');
                        }
                    } catch (httpsError) {
                        console.warn('‚ö†Ô∏è HTTPS no disponible, usando HTTP:', httpsError.message);
                    }
                }
                */
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 
                        message: message,
                        conversation_id: conversationId || 'default',
                        model: 'gemini-pro',
                        stream: false
                    }),
                    signal: controller.signal,
                    credentials: 'same-origin'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Actualizar m√©tricas de rendimiento
                const responseTime = performance.now() - startTime;
                updateClientMetrics(responseTime);
                
                hideTyping();
                
                if (data.success) {
                    addMessage(data.message, 'bot');
                    retryCount = 0; // Reset retry count on success
                    
                    // S√≠ntesis de voz si est√° habilitada
                    if (isVoiceEnabled && 'speechSynthesis' in window) {
                        speakText(data.message);
                    }
                } else {
                    addMessage('‚ùå Error: ' + (data.message || 'Error desconocido'), 'bot');
                    showNotification('Error al enviar el mensaje', 'error');
                }
                
            } catch (error) {
                hideTyping();
                console.error('Error:', error);
                
                if (error.name === 'AbortError') {
                    showNotification('Tiempo de espera agotado. Por favor, int√©ntalo de nuevo.', 'error');
                } else if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    showNotification(`Error de conexi√≥n. Reintentando... (${retryCount}/${MAX_RETRIES})`, 'warning');
                    setTimeout(() => sendMessage(), RETRY_DELAY * retryCount);
                    return;
                } else {
                    addMessage('üîå Error de conexi√≥n: ' + error.message, 'bot');
                    showNotification('Error de conexi√≥n', 'error');
                    retryCount = 0;
                }
            } finally {
                // Rehabilitar input y garantizar interactividad
                isLoading = false;
                // Forzar input siempre habilitado
                if (messageInput) {
                    messageInput.disabled = false;
                    messageInput.focus();
                }
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.innerHTML = '<span>Enviar</span><span>üì§</span>';
                }
            }
        }
        
        // Actualizar m√©tricas del cliente
        function updateClientMetrics(responseTime) {
            clientMetrics.messagesCount++;
            clientMetrics.lastMessageTime = Date.now();
            
            // Calcular tiempo de respuesta promedio
            if (clientMetrics.averageResponseTime === 0) {
                clientMetrics.averageResponseTime = responseTime;
            } else {
                clientMetrics.averageResponseTime = 
                    (clientMetrics.averageResponseTime + responseTime) / 2;
            }
        }
        
        // Inicializaci√≥n DOM
        document.addEventListener('DOMContentLoaded', function() {
                // 13. MutationObserver to keep input enabled
                if (messageInput) {
                    const observer = new MutationObserver(() => {
                        if (messageInput.disabled) {
                            messageInput.disabled = false;
                        }
                    });
                    observer.observe(messageInput, { attributes: true, attributeFilter: ['disabled'] });
                }
                
                // El script del modo SOLO se carga al final del documento
                // No es necesario cargarlo din√°micamente aqu√≠
            try {
                // Inicializar elementos DOM
                messagesContainer = document.getElementById('messages');
                messageInput = document.getElementById('messageInput');
                sendButton = document.getElementById('sendButton');
                typingIndicator = document.getElementById('typing');
                charCounter = document.getElementById('charCounter');
                
                
                // Verificar que todos los elementos existen
                if (!messagesContainer || !messageInput || !sendButton || !typingIndicator || !charCounter) {
                    console.error('Error: No se pudieron encontrar todos los elementos DOM necesarios');
                    return;
                }
                
                console.log('‚úÖ Elementos DOM encontrados correctamente');
                
                // 1. Inicializar cache DOM
                initDOMCache();
                
                // 2. Inicializar estilos CSS
                initializeStyles();
                
                // 3. Configurar event listeners
                setupEventListeners();
                
                // 4. Inicializar contadores y UI
                updateCharCounter();
                
                // 5. Agregar mensaje de bienvenida
                setTimeout(() => {
                    addWelcomeMessage();
                }, 100);
                
                // 6. Focus inicial en el input
                if (messageInput) {
                    messageInput.disabled = false;
                    messageInput.focus();
                }
                
                // Iniciar el loop de forceEnableInput
                forceEnableInput();

                // 12. Periodic check to keep input enabled
                setInterval(() => {
                    if (messageInput && messageInput.disabled) {
                        messageInput.disabled = false;
                    }
                }, 500);
                
                // 7. Inicializar efectos visuales optimizados
                createFloatingParticles();
                setInterval(createParticle, 300);
                
                // 8. Inicializar efectos del fondo de part√≠culas
                initializeParticlesBackground();
                
                // 9. Inicializar Service Worker
                initializeServiceWorker();
                
                // 10. Logs finales
                console.log('‚úÖ Chat inicializado correctamente');
                console.log('üí° Atajos: Ctrl+K (focus input), Ctrl+L (limpiar chat)');
                
                // 11. Notificaci√≥n final (con delay para asegurar que las animaciones est√©n listas)
                setTimeout(() => {
                    showNotification('¬°Chat mejorado listo! üöÄ', 'success');
                }, 200);
                
            } catch (error) {
                console.error('Error durante la inicializaci√≥n:', error);
            }
        });

        
        // Nuevas funciones
        function updateCharCounter() {
            try {
                if (!messageInput || !charCounter) {
                    return;
                }
                
                const currentLength = messageInput.value.length;
                charCounter.textContent = `${currentLength}/1000`;
                
                if (currentLength > 800) {
                    charCounter.style.color = 'var(--warning-color)';
                } else if (currentLength > 950) {
                    charCounter.style.color = 'var(--error-color)';
                } else {
                    charCounter.style.color = 'var(--text-secondary)';
                }
            } catch (error) {
                console.error('Error al actualizar contador de caracteres:', error);
            }
        }
        

        
        function addWelcomeMessage() {
            addMessage('¬°Hola! Soy tu asistente de IA. ¬øEn qu√© puedo ayudarte hoy?', 'bot');
        }
        
        function clearChat() {
            try {
                if (confirm('¬øEst√°s seguro de que quieres limpiar el chat?')) {
                    if (messagesContainer) {
                        messagesContainer.innerHTML = '';
                    }
                    chatHistory = [];
                    addWelcomeMessage();
                    showNotification('Chat limpiado', 'success');
                }
            } catch (error) {
                console.error('Error al limpiar chat:', error);
                showNotification('Error al limpiar el chat', 'error');
            }
        }
        
        function exportChat() {
            if (chatHistory.length === 0) {
                showNotification('No hay mensajes para exportar', 'warning');
                return;
            }
            
            const chatText = chatHistory.map(msg => 
                `[${new Date(msg.timestamp).toLocaleString('es-ES')}] ${msg.sender.toUpperCase()}: ${msg.text}`
            ).join('\n\n');
            
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-gemini-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Chat exportado exitosamente', 'success');
        }
        
        function toggleVoice() {
            if (!('speechSynthesis' in window)) {
                showNotification('Tu navegador no soporta s√≠ntesis de voz', 'error');
                return;
            }
            
            isVoiceEnabled = !isVoiceEnabled;
            const voiceBtn = document.querySelector('.input-actions .action-btn:nth-child(3)');
            if (voiceBtn) {
                voiceBtn.innerHTML = isVoiceEnabled ? 'üîä Voz ON' : 'üé§ Voz';
                voiceBtn.style.background = isVoiceEnabled ? 'rgba(0, 255, 136, 0.2)' : 'rgba(0, 245, 255, 0.1)';
                voiceBtn.style.borderColor = isVoiceEnabled ? 'rgba(0, 255, 136, 0.5)' : 'rgba(0, 245, 255, 0.3)';
                voiceBtn.style.color = isVoiceEnabled ? 'var(--success-color)' : 'var(--text-secondary)';
            }
            
            showNotification(`S√≠ntesis de voz ${isVoiceEnabled ? 'activada' : 'desactivada'}`, 'success');
        }
        
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            
            const colors = {
                success: 'var(--success-color)',
                error: 'var(--error-color)',
                warning: 'var(--warning-color)',
                info: 'var(--primary)'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        
        // Funciones de carga de archivos
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        }
        
        function handleFileUpload(files) {
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                // Validar tama√±o del archivo (m√°ximo 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`El archivo ${file.name} es demasiado grande (m√°ximo 10MB)`, 'error');
                    return;
                }
                
                // Validar tipo de archivo
                const allowedTypes = ['text/plain', 'application/pdf', 'application/msword', 
                                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                    'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                
                if (!allowedTypes.includes(file.type)) {
                    showNotification(`Tipo de archivo no soportado: ${file.name}`, 'error');
                    return;
                }
                
                // Mostrar archivo cargado en el chat
                const fileInfo = `üìé Archivo cargado: ${file.name} (${formatFileSize(file.size)})`;
                addMessage(fileInfo, 'user');
                
                // Procesar archivo seg√∫n su tipo
                if (file.type.startsWith('text/')) {
                    readTextFile(file);
                } else if (file.type.startsWith('image/')) {
                    processImageFile(file);
                } else {
                    // Para PDF y documentos, mostrar informaci√≥n b√°sica
                    addMessage(`üìÑ Documento recibido: ${file.name}. El bot puede ayudarte con preguntas sobre este archivo.`, 'bot');
                }
                
                showNotification(`Archivo ${file.name} cargado exitosamente`, 'success');
            });
        }
        
        function readTextFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                addMessage(`üìù Contenido del archivo:\n${preview}`, 'bot');
            };
            reader.readAsText(file);
        }
        
        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '8px';
                img.style.marginTop = '8px';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = 'ü§ñ';
                
                const contentWrapper = document.createElement('div');
                const content = document.createElement('div');
                content.className = 'message-content';
                content.innerHTML = `üñºÔ∏è Imagen recibida: ${file.name}`;
                content.appendChild(img);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                contentWrapper.appendChild(content);
                contentWrapper.appendChild(timeDiv);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentWrapper);
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };
            reader.readAsDataURL(file);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Funci√≥n para configurar event listeners
        function setupEventListeners() {
            try {
                // Event Listeners para input
                if (messageInput) {
                    messageInput.addEventListener('input', updateCharCounter);
                    
                    messageInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                    
                    // Focus inicial
                    messageInput.focus();
                }
                

                
                // Event listener para el bot√≥n de enviar
                if (sendButton) {
                    sendButton.addEventListener('click', sendMessage);
                }
                
                // Event listener para carga de archivos
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        handleFileUpload(e.target.files);
                        // Limpiar el input para permitir cargar el mismo archivo nuevamente
                        e.target.value = '';
                    });
                }
                
                // Event listeners para botones de acci√≥n
                const actionButtons = document.querySelectorAll('.action-btn');
                if (actionButtons.length >= 4) {
                    // Bot√≥n limpiar chat (primer bot√≥n)
                    actionButtons[0].addEventListener('click', clearChat);
                    
                    // Bot√≥n exportar (segundo bot√≥n)
                    actionButtons[1].addEventListener('click', exportChat);
                    
                    // Bot√≥n voz (tercer bot√≥n)
                    actionButtons[2].addEventListener('click', toggleVoice);
                    
                    // Bot√≥n archivo (cuarto bot√≥n)
                    actionButtons[3].addEventListener('click', uploadFile);
                }
                
                // Configurar drag and drop
                setupDragAndDrop();
                
                // Configurar atajos de teclado
                setupKeyboardShortcuts();
                
                // Configurar botones de idioma
                setupLanguageButtons();
                
                console.log('‚úÖ Event listeners configurados correctamente');
            } catch (error) {
                console.error('Error al configurar event listeners:', error);
            }
        }
        
        // Funci√≥n para configurar drag and drop
        function setupDragAndDrop() {
            if (!messagesContainer) return;
            
            messagesContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                messagesContainer.style.backgroundColor = 'rgba(0, 245, 255, 0.1)';
            });
            
            messagesContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                messagesContainer.style.backgroundColor = '';
            });
            
            messagesContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                messagesContainer.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files);
                }
            });
        }
        
        // Funci√≥n para configurar atajos de teclado
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    if (messageInput) messageInput.focus();
                }
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    clearChat();
                }
            });
        }
        
        // Los event listeners ahora se configuran en setupEventListeners()
        
        // === FUNCIONES DE ANIMACI√ìN OPTIMIZADAS ===
        function createFloatingParticles() {
            if (!PERFORMANCE_CONFIG.enableParticles) return;
            
            const container = getElement('particleContainer');
            if (!container) return;

            // Pool de part√≠culas reutilizables
            const particlePool = [];
            
            function getParticleFromPool() {
                if (particlePool.length > 0) {
                    return particlePool.pop();
                }
                
                const particle = document.createElement('div');
                particle.className = 'particle';
                return particle;
            }
            
            function returnParticleToPool(particle) {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
                particle.style.animation = '';
                particlePool.push(particle);
            }

            function createParticle() {
                if (particles.length >= MAX_PARTICLES) return;
                
                // Verificar si el usuario est√° inactivo para reducir animaciones
                if (document.hidden) return;

                const particle = getParticleFromPool();
                
                // Posici√≥n inicial optimizada
                const startX = Math.random() * window.innerWidth;
                const startY = window.innerHeight + 10;
                
                particle.style.left = startX + 'px';
                particle.style.top = startY + 'px';
                
                // Propiedades de animaci√≥n optimizadas
                const duration = 6000 + Math.random() * 3000; // Reducido
                const drift = (Math.random() - 0.5) * 80; // Reducido
                
                particle.style.animation = `float ${duration}ms linear`;
                particle.style.setProperty('--drift', drift + 'px');
                
                container.appendChild(particle);
                particles.push(particle);
                
                // Usar setTimeout optimizado
                setTimeout(() => {
                    const index = particles.indexOf(particle);
                    if (index > -1) {
                        particles.splice(index, 1);
                        returnParticleToPool(particle);
                    }
                }, duration);
            }

            function animate() {
                const now = performance.now();
                if (now - lastParticleTime > PARTICLE_INTERVAL) {
                    createParticle();
                    lastParticleTime = now;
                }
                
                // Solo continuar animaci√≥n si la p√°gina est√° visible
                if (!document.hidden) {
                    animationId = requestAnimationFrame(animate);
                } else {
                    // Reanudar cuando la p√°gina vuelva a ser visible
                    document.addEventListener('visibilitychange', function resumeAnimation() {
                        if (!document.hidden) {
                            document.removeEventListener('visibilitychange', resumeAnimation);
                            animate();
                        }
                    });
                }
            }

            animate();
        }
        
        // Create floating particles (funci√≥n simplificada para compatibilidad)
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + 'vw';
            particle.style.animationDelay = Math.random() * 6 + 's';
            particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
            document.body.appendChild(particle);
            
            setTimeout(() => {
                particle.remove();
            }, 6000);
        }
        
        // Funci√≥n para inicializar animaciones CSS
        function initializeStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
                
                /* Estilos para drag and drop */
                .chat-messages.drag-over {
                    background: rgba(0, 245, 255, 0.1) !important;
                    border: 2px dashed var(--primary) !important;
                    border-radius: 12px;
                }
                
                /* Estilos para el bot√≥n de archivo */
                .action-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
                }
                
                /* Estilos para im√°genes en mensajes */
                .message-content img {
                    transition: transform 0.3s ease;
                    cursor: pointer;
                }
                
                .message-content img:hover {
                    transform: scale(1.05);
                }
            `;
            document.head.appendChild(style);
        }
        
        // Funci√≥n para inicializar Service Worker con soporte HTTPS
        function initializeServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Verificar si estamos en un contexto seguro (HTTPS)
                const isSecureContext = window.isSecureContext || window.location.protocol === 'https:';
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                if (isSecureContext || isLocalhost) {
                    navigator.serviceWorker.register('/sw.js')
                        .then(function(registration) {
                            console.log('‚úÖ Service Worker registrado:', registration.scope);
                            
                            // Escuchar mensajes del Service Worker
                            navigator.serviceWorker.addEventListener('message', function(event) {
                                if (event.data.type === 'SW_ACTIVATED') {
                                    console.log('üîÑ Service Worker activado con HTTPS:', event.data.version);
                                    if (event.data.features && event.data.features.caching) {
                                        showNotification('PWA optimizada con HTTPS activada', 'success');
                                    }
                                }
                                
                                if (event.data.type === 'PERFORMANCE_UPDATE') {
                                    console.log('üìä M√©tricas de rendimiento:', event.data.metrics);
                                }
                            });
                            
                            // Verificar actualizaciones del Service Worker
                            registration.addEventListener('updatefound', function() {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', function() {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showNotification('Nueva versi√≥n disponible. Recarga para actualizar.', 'info');
                                    }
                                });
                            });
                        })
                        .catch(function(error) {
                            console.log('‚ùå Error registrando Service Worker:', error);
                            if (!isSecureContext && !isLocalhost) {
                                showNotification('PWA requiere HTTPS para funcionalidad completa', 'warning');
                            }
                        });
                } else {
                    console.warn('‚ö†Ô∏è Service Worker requiere contexto seguro (HTTPS)');
                    showNotification('Para funcionalidad PWA completa, usa HTTPS', 'info');
                }
            } else {
                console.warn('‚ö†Ô∏è Service Worker no soportado en este navegador');
            }
        }
        
        // Funci√≥n para limpiar cache del navegador
        function clearBrowserCache() {
            try {
                // Limpiar localStorage
                if (typeof(Storage) !== "undefined") {
                    localStorage.clear();
                }
                
                // Limpiar sessionStorage
                if (typeof(Storage) !== "undefined") {
                    sessionStorage.clear();
                }
                
                // Forzar recarga sin cache
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        for (let name of names) {
                            caches.delete(name);
                        }
                    });
                }
                
                console.log('‚úÖ Cache del navegador limpiado');
            } catch (error) {
                console.error('Error al limpiar cache:', error);
            }
        }
        
        // Funci√≥n para validar sintaxis JavaScript
        function validateJavaScriptSyntax() {
            try {
                // Verificar que todas las funciones est√©n correctamente definidas
                const requiredFunctions = [
                    'addMessage', 'showTyping', 'hideTyping',
                    'sendMessage', 'updateCharCounter', 'clearChat',
                    'exportChat', 'toggleVoice', 'uploadFile', 'setupEventListeners'
                ];
                
                requiredFunctions.forEach(funcName => {
                    if (typeof window[funcName] !== 'function') {
                        console.error(`‚ùå Funci√≥n ${funcName} no est√° definida`);
                    } else {
                        console.log(`‚úÖ Funci√≥n ${funcName} correctamente definida`);
                    }
                });
                
                console.log('‚úÖ Validaci√≥n de sintaxis JavaScript completada');
                return true;
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de sintaxis:', error);
                return false;
            }
        }
        
        // Inicializar fondo de part√≠culas
        function initializeParticlesBackground() {
            // Variables para el canvas de red neuronal
            const canvas = document.getElementById('neural-canvas');
            const ctx = canvas.getContext('2d');
            let neuralParticles = [];
            let neuralAnimationId;

            // Configuraci√≥n de part√≠culas
            const config = {
                particleCount: 100,
                maxDistance: 120,
                particleSpeed: 0.5,
                nodeRadius: 2,
                connectionOpacity: 0.3,
                particleOpacity: 0.7
            };

            // Clase Particle
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.vx = (Math.random() - 0.5) * config.particleSpeed;
                    this.vy = (Math.random() - 0.5) * config.particleSpeed;
                    this.radius = config.nodeRadius + Math.random() * 2;
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;

                    // Rebote en los bordes
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;

                    // Mantener dentro de los l√≠mites
                    this.x = Math.max(0, Math.min(canvas.width, this.x));
                    this.y = Math.max(0, Math.min(canvas.height, this.y));
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0, 212, 255, ${config.particleOpacity})`;
                    ctx.fill();

                    // Efecto de brillo
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius * 0.5, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                }
            }

            // Inicializar canvas
            function initCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            // Crear part√≠culas
            function createParticles() {
                neuralParticles = [];
                for (let i = 0; i < config.particleCount; i++) {
                    neuralParticles.push(new Particle());
                }
            }

            // Dibujar conexiones entre part√≠culas
            function drawConnections() {
                for (let i = 0; i < neuralParticles.length; i++) {
                    for (let j = i + 1; j < neuralParticles.length; j++) {
                        const dx = neuralParticles[i].x - neuralParticles[j].x;
                        const dy = neuralParticles[i].y - neuralParticles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < config.maxDistance) {
                            const opacity = (1 - distance / config.maxDistance) * config.connectionOpacity;
                            ctx.beginPath();
                            ctx.moveTo(neuralParticles[i].x, neuralParticles[i].y);
                            ctx.lineTo(neuralParticles[j].x, neuralParticles[j].y);
                            ctx.strokeStyle = `rgba(0, 212, 255, ${opacity})`;
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                    }
                }
            }

            // Loop de animaci√≥n
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Actualizar y dibujar part√≠culas
                neuralParticles.forEach(particle => {
                    particle.update();
                    particle.draw();
                });

                // Dibujar conexiones
                drawConnections();

                neuralAnimationId = requestAnimationFrame(animate);
            }

            // Redimensionar canvas
            function resizeCanvas() {
                initCanvas();
                createParticles();
            }

            // Event listeners para el canvas
            window.addEventListener('resize', resizeCanvas);

            // Inicializar red neuronal
            initCanvas();
            createParticles();
            animate();

            // Efecto de interacci√≥n con el mouse en las part√≠culas
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                neuralParticles.forEach(particle => {
                    const dx = mouseX - particle.x;
                    const dy = mouseY - particle.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 100) {
                        const force = (100 - distance) / 100;
                        particle.vx += dx * force * 0.001;
                        particle.vy += dy * force * 0.001;
                    }
                });
            });
        }
        
        // Limpiar cache al cargar la p√°gina
        window.addEventListener('load', function() {
            clearBrowserCache();
            validateJavaScriptSyntax();
            initializeParticlesBackground();
        });
        
        // Forzar recarga sin cache si hay errores
        window.addEventListener('error', function(e) {
            if (e.message.includes('SyntaxError') || e.message.includes('Unexpected token')) {
                console.warn('üîÑ Error de sintaxis detectado, forzando recarga sin cache...');
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            }
        });

        // Internacionalizaci√≥n b√°sica con botones
        function setupLanguageButtons() {
            const langButtons = document.querySelectorAll('.lang-btn');
            
            langButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    document.documentElement.lang = lang;
                    
                    // Resaltar el bot√≥n del idioma seleccionado
                    langButtons.forEach(btn => {
                        btn.style.background = 'rgba(0, 245, 255, 0.1)';
                        btn.style.borderColor = 'rgba(0, 245, 255, 0.3)';
                        btn.style.color = 'var(--text-secondary)';
                    });
                    
                    this.style.background = 'rgba(0, 255, 136, 0.2)';
                    this.style.borderColor = 'rgba(0, 255, 136, 0.5)';
                    this.style.color = 'var(--success-color)';
                    
                    showNotification(`Idioma cambiado a ${lang === 'es' ? 'Espa√±ol' : 'English'}`, 'success');
                });
            });
            
            // Resaltar el bot√≥n del idioma actual al cargar
            const currentLang = document.documentElement.lang || 'es';
            const currentLangButton = document.querySelector(`.lang-btn[data-lang="${currentLang}"]`);
            if (currentLangButton) {
                currentLangButton.style.background = 'rgba(0, 255, 136, 0.2)';
                currentLangButton.style.borderColor = 'rgba(0, 255, 136, 0.5)';
                currentLangButton.style.color = 'var(--success-color)';
            }
        }
        
        // Script de pruebas desactivado
        // El bucle autom√°tico de pruebas ha sido eliminado para evitar ejecuciones no deseadas
        console.log('‚ÑπÔ∏è Modo de pruebas autom√°ticas desactivado');
        // Para ejecutar pruebas, usar los comandos espec√≠ficos desde la terminal
    </script>
    
    <!-- Scripts de desarrollo (solo se cargan en entorno local) -->
    <script>
        // Verificar si estamos en entorno de desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Funci√≥n para habilitar las herramientas de desarrollo
            function enableDevTools() {
                console.log('üõ†Ô∏è Herramientas de desarrollo habilitadas');
                
                // Exponer funciones √∫tiles para depuraci√≥n
                window.debugChat = {
                    clearMessages: function() {
                        document.querySelector('.chat-messages').innerHTML = '';
                        console.log('Mensajes borrados');
                    },
                    simulateError: function() {
                        console.error('Error simulado para pruebas');
                        throw new Error('Error simulado para pruebas');
                    },
                    toggleTestMode: function() {
                        document.body.classList.toggle('test-mode');
                        console.log('Modo de prueba: ' + (document.body.classList.contains('test-mode') ? 'activado' : 'desactivado'));
                    }
                };
            }
            
            // Habilitar herramientas de desarrollo
            enableDevTools();
        }
    </script>
</body>
</html>
